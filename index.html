<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoramento Passo a Passo – Capabilidade do Processo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f6f6f6; }
  h1 { text-align: center; }
  .step { margin: 15px 0; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  input[type="number"], input[type="text"] { padding: 5px; margin: 5px 0; width: 120px; }
  button { padding: 6px 12px; margin: 5px; border: none; border-radius: 6px; background-color: #007bff; color: white; cursor: pointer; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
</style>
</head>
<body>

<h1>Monitoramento Passo a Passo – Capabilidade do Processo</h1>

<!-- Nome do aluno -->
<div class="step">
  <label>Nome do estudante: <input type="text" id="studentName" placeholder="Digite seu nome"></label>
</div>

<!-- Entrada do tamanho da amostra e número de amostras -->
<div class="step">
  <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
  <label>Número de amostras (k): <input type="number" id="numSamples" min="1"></label>
  <button onclick="gerarTabela()">Gerar Tabela</button>
</div>

<!-- Tabela de observações, X̄ e R -->
<div class="step" id="tableContainer" style="display:none;">
  <h3>Preencha as medições, médias e amplitudes</h3>
  <table id="sampleTable"></table>
  <button onclick="verificarMediasER()">Verificar Médias e Amplitudes</button>
  <div id="feedbackMedias"></div>
</div>

<!-- Limites de especificação e cálculo de Cp/Cpk -->
<div class="step" id="capabilityStep" style="display:none;">
  <h3>Calcular Cp e Cpk</h3>
  <label>Limite inferior (LSL): <input type="number" id="lsl" step="0.001"></label><br>
  <label>Limite superior (USL): <input type="number" id="usl" step="0.001"></label><br>
  <label>Média do processo (X̄ global): <input type="number" id="xBarGlobal" disabled></label><br>
  <label>Desvio padrão (σ): <input type="number" id="sigmaGlobal" disabled></label><br>
  <label>Cp calculado: <input type="number" id="cpAluno" step="0.001"></label><br>
  <label>Cpk calculado: <input type="number" id="cpkAluno" step="0.001"></label><br>
  <button onclick="verificarCpCpk()">Verificar Cp e Cpk</button>
  <div id="feedbackCpCpk"></div>
</div>

<!-- Resultado final -->
<div class="step">
  <h3>Resultado Final</h3>
  <button onclick="mostrarNota()">Mostrar Resultado</button>
  <div id="feedbackFinal"></div>
</div>

<script>
// Tabelas de constantes
const d2_table = {2:1.128,3:1.693,4:2.059,5:2.326,6:2.534,7:2.704,8:2.847,9:2.970,10:3.078,11:3.173,12:3.258,13:3.336,14:3.407,15:3.472};

let sampleValues = [];
let sampleMedia = [];
let sampleR = [];
let n=0, k=0;
let passosCorretos = [false,false,false,false]; // Passos: Medias/R e Cp/Cpk

// Gerar tabela de entrada
function gerarTabela(){
    n = parseInt(document.getElementById('sampleSize').value);
    k = parseInt(document.getElementById('numSamples').value);
    if(isNaN(n) || isNaN(k) || n<2 || n>15 || k<1){ alert("Digite valores válidos!"); return; }

    const table = document.getElementById('sampleTable');
    table.innerHTML="";
    // Cabeçalho
    let thead="<tr><th>Amostra</th>";
    for(let j=1;j<=n;j++) thead += `<th>X${j}</th>`;
    thead += "<th>X̄</th><th>R</th></tr>";
    table.innerHTML += thead;
    // Linhas
    for(let i=1;i<=k;i++){
        let row=`<tr><td>${i}</td>`;
        for(let j=1;j<=n;j++) row += `<td><input type="number" step="0.001" id="cell_${i}_${j}"></td>`;
        row += `<td><input type="number" step="0.001" id="media_${i}"></td>`;
        row += `<td><input type="number" step="0.001" id="r_${i}"></td></tr>`;
        table.innerHTML += row;
    }
    document.getElementById('tableContainer').style.display='block';
}

// Verificar médias e amplitudes
function verificarMediasER(){
    let feedback="";
    let todosCorretos=true;
    sampleValues=[]; sampleMedia=[]; sampleR=[];
    for(let i=1;i<=k;i++){
        let valores=[];
        for(let j=1;j<=n;j++){
            valores.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
        }
        const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
        const amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
        const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value)||0;
        const rAluno = parseFloat(document.getElementById(`r_${i}`).value)||0;

        sampleValues.push(valores);
        sampleMedia.push(mediaCorreta); // Para módulo professor
        sampleR.push(amplitudeCorreta);  // Para módulo professor

        if(Math.abs(mediaAluno - mediaCorreta) > 0.001 || Math.abs(rAluno - amplitudeCorreta) > 0.001){
            feedback += `❌ Amostra ${i}: Média ou R incorreto(a)<br>`;
            todosCorretos=false;
        } else feedback += `✔️ Amostra ${i}: Correto<br>`;
    }
    document.getElementById('feedbackMedias').innerHTML=feedback;
    if(todosCorretos){
        // Ativar passo de Cp/Cpk
        document.getElementById('capabilityStep').style.display='block';
        // Calcula valores globais, mas não mostra para o aluno
        const xBarGlobal = sampleMedia.reduce((a,b)=>a+b,0)/k;
        const rBarGlobal = sampleR.reduce((a,b)=>a+b,0)/k;
        const sigmaGlobal = rBarGlobal/d2_table[n];
        document.getElementById('xBarGlobal').value = xBarGlobal.toFixed(3);
        document.getElementById('sigmaGlobal').value = sigmaGlobal.toFixed(3);
    }
}

// Verificar Cp e Cpk
function verificarCpCpk(){
    const lsl = parseFloat(document.getElementById('lsl').value);
    const usl = parseFloat(document.getElementById('usl').value);
    const xBarGlobal = parseFloat(document.getElementById('xBarGlobal').value);
    const sigmaGlobal = parseFloat(document.getElementById('sigmaGlobal').value);
    const cpAluno = parseFloat(document.getElementById('cpAluno').value);
    const cpkAluno = parseFloat(document.getElementById('cpkAluno').value);

    if(isNaN(lsl) || isNaN(usl) || isNaN(cpAluno) || isNaN(cpkAluno)){
        alert("Preencha todos os campos!");
        return;
    }

    const cpCorreto = (usl-lsl)/(6*sigmaGlobal);
    const cpkCorreto = Math.min((usl - xBarGlobal)/(3*sigmaGlobal),(xBarGlobal - lsl)/(3*sigmaGlobal));
    const tol = 0.01;
    let feedback="";
    if(Math.abs(cpAluno-cpCorreto)<=tol && Math.abs(cpkAluno-cpkCorreto)<=tol){
        feedback="✔️ Cp e Cpk corretos!";
        passosCorretos[1]=true;
    } else {
        feedback=`❌ Cp ou Cpk incorreto(s). Valor esperado aproximado: Cp=${cpCorreto.toFixed(3)}, Cpk=${cpkCorreto.toFixed(3)}`;
        passosCorretos[1]=false;
    }
    document.getElementById('feedbackCpCpk').innerHTML=feedback;
}

// Resultado final
function mostrarNota(){
    const name=document.getElementById('studentName').value||'Aluno';
    const certos = passosCorretos.filter(Boolean).length;
    const nota = Math.round((certos/2)*100*100)/100;
    document.getElementById('feedbackFinal').innerHTML=`${name} — Passos corretos: ${certos}/2. Desempenho: ${nota.toFixed(2)}%`;
}
</script>
</body>
</html>
