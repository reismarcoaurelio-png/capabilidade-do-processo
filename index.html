<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capabilidade do Processo - Completo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f6f6f6; }
  h1 { text-align: center; }
  .step { margin: 15px 0; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  input[type="number"], input[type="text"], input[type="password"] { padding: 5px; margin: 5px 0; width: 120px; }
  button { padding: 6px 12px; margin: 5px; border: none; border-radius: 6px; background-color: #007bff; color: white; cursor: pointer; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>Monitoramento Passo a Passo ‚Äì Capabilidade do Processo</h1>

<!-- Entrada aluno -->
<div class="step">
  <h3>Dados do Estudante</h3>
  <label>Nome do estudante: <input type="text" id="studentName" placeholder="Digite seu nome"></label><br>
  <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
  <label>N√∫mero de amostras (k): <input type="number" id="numSamples" min="1"></label>
  <button onclick="gerarTabela()">Gerar Tabela</button>
</div>

<div id="tableContainer" class="step" style="display:none;">
  <h3>Preencha os valores das observa√ß√µes, XÃÑ e R de cada amostra</h3>
  <table id="sampleTable"></table>
  <button onclick="verificarMediasER()">Verificar M√©dias e Amplitudes</button>
  <div id="feedback"></div>
</div>

<!-- Limites e Cp/Cpk -->
<div class="step" id="capabilidadeAluno" style="display:none;">
  <h3>Capabilidade do Processo</h3>
  <label>Limite Inferior (LSL): <input type="number" id="lsl" step="0.001"></label><br>
  <label>Limite Superior (USL): <input type="number" id="usl" step="0.001"></label><br>
  <label>Cp: <input type="number" id="cpAluno" step="0.001"></label><br>
  <label>Cpk: <input type="number" id="cpkAluno" step="0.001"></label><br>
  <button onclick="verificarCpCpk()">Verificar Cp e Cpk</button>
  <div id="feedbackCpCpk"></div>
</div>

<!-- M√≥dulo professor -->
<div class="step">
  <h3>M√≥dulo Professor</h3>
  <label>Senha: <input type="password" id="profPass" placeholder="Senha"></label>
  <button onclick="ativarProfessor()">Ativar</button>
  <div id="feedbackProfessor"></div>
  <button onclick="preencherTabelaProfessor()" id="fillButton" style="display:none;">Preencher XÃÑ e R</button>
  <div id="resultadoProfessor"></div>
  <button onclick="gerarPDFAluno()" style="margin-top:10px;">Gerar Relat√≥rio PDF</button>
</div>

<script>
let n, k;
let passosAlunoCorretos = false;
const d2_table = {2:1.128,3:1.693,4:2.059,5:2.326,6:2.534,7:2.704,8:2.847,9:2.970,10:3.078,11:3.173,12:3.258,13:3.336,14:3.407,15:3.472};

// Gerar tabela de observa√ß√µes
function gerarTabela(){
  n = parseInt(document.getElementById('sampleSize').value);
  k = parseInt(document.getElementById('numSamples').value);
  if(isNaN(n) || isNaN(k) || n<2 || n>15 || k<1){ alert("Digite valores v√°lidos!"); return; }

  const table = document.getElementById('sampleTable');
  table.innerHTML = "";
  let head = "<tr><th>Amostra</th>";
  for(let j=1;j<=n;j++) head += `<th>X${j}</th>`;
  head += "<th>XÃÑ</th><th>R</th></tr>";
  table.innerHTML = head;

  for(let i=1;i<=k;i++){
    let row = `<tr><td>${i}</td>`;
    for(let j=1;j<=n;j++) row += `<td><input type="number" id="cell_${i}_${j}" step="0.001"></td>`;
    row += `<td><input type="number" id="media_${i}" step="0.001"></td>`;
    row += `<td><input type="number" id="r_${i}" step="0.001"></td></tr>`;
    table.innerHTML += row;
  }
  document.getElementById('tableContainer').style.display='block';
}

// Verificar m√©dias e amplitudes do aluno
function verificarMediasER(){
  let feedback="";
  let todasCorretas=true;
  for(let i=1;i<=k;i++){
    let valores=[];
    for(let j=1;j<=n;j++){
      valores.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
    }
    let mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    let amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
    let mediaAluno=parseFloat(document.getElementById(`media_${i}`).value)||0;
    let rAluno=parseFloat(document.getElementById(`r_${i}`).value)||0;

    if(Math.abs(mediaAluno-mediaCorreta)>0.001 || Math.abs(rAluno-amplitudeCorreta)>0.001){
      feedback += `‚ùå Amostra ${i}: M√©dia ou R incorreto(a)<br>`;
      todasCorretas=false;
    }else{
      feedback += `‚úîÔ∏è Amostra ${i}: Correto<br>`;
    }
  }
  if(todasCorretas){
    feedback+="üéâ Todas as m√©dias e amplitudes est√£o corretas!";
    document.getElementById('capabilidadeAluno').style.display='block';
    passosAlunoCorretos=true;
  }
  document.getElementById('feedback').innerHTML=feedback;
}

// Verificar Cp e Cpk do aluno
function verificarCpCpk(){
  const lsl=parseFloat(document.getElementById('lsl').value);
  const usl=parseFloat(document.getElementById('usl').value);
  const medias=[], rs=[];
  for(let i=1;i<=k;i++){
    medias.push(parseFloat(document.getElementById(`media_${i}`).value)||0);
    rs.push(parseFloat(document.getElementById(`r_${i}`).value)||0);
  }
  const xBarGlobal = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = rs.reduce((a,b)=>a+b,0)/k;
  const sigma = rBarGlobal/d2_table[n];
  const cpCorreto = (usl-lsl)/(6*sigma);
  const cpkCorreto = Math.min((usl-xBarGlobal)/(3*sigma),(xBarGlobal-lsl)/(3*sigma));

  const cpAluno=parseFloat(document.getElementById('cpAluno').value)||0;
  const cpkAluno=parseFloat(document.getElementById('cpkAluno').value)||0;
  const tol=0.01;
  let feedback="";
  if(Math.abs(cpAluno-cpCorreto)<=tol && Math.abs(cpkAluno-cpkCorreto)<=tol){
    feedback=`‚úîÔ∏è Cp e Cpk corretos (Cp‚âà${cpCorreto.toFixed(3)}, Cpk‚âà${cpkCorreto.toFixed(3)})`;
  }else{
    feedback=`‚ùå Cp ou Cpk incorretos. Valor esperado: Cp‚âà${cpCorreto.toFixed(3)}, Cpk‚âà${cpkCorreto.toFixed(3)}`;
  }
  document.getElementById('feedbackCpCpk').innerHTML=feedback;
}

// M√≥dulo professor
function ativarProfessor(){
  const senha=document.getElementById('profPass').value;
  if(senha==='2806ANdr*'){
    document.getElementById('feedbackProfessor').innerHTML="‚úîÔ∏è M√≥dulo professor ativado!";
    document.getElementById('fillButton').style.display='inline-block';
    calcularProfessor();
  }else{
    document.getElementById('feedbackProfessor').innerHTML="‚ùå Senha incorreta.";
  }
}

// C√°lculo autom√°tico professor
function calcularProfessor(){
  if(!n || !k) return;
  const medias=[], rs=[];
  for(let i=1;i<=k;i++){
    let valores=[];
    for(let j=1;j<=n;j++){
      valores.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
    }
    const media=valores.reduce((a,b)=>a+b,0)/n;
    const r=Math.max(...valores)-Math.min(...valores);
    medias.push(media);
    rs.push(r);
  }
  const xBarGlobal = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = rs.reduce((a,b)=>a+b,0)/k;
  const sigma = rBarGlobal/d2_table[n];
  const lsl=parseFloat(document.getElementById('lsl').value)||0;
  const usl=parseFloat(document.getElementById('usl').value)||0;
  const cp = (usl-lsl)/(6*sigma);
  const cpk = Math.min((usl-xBarGlobal)/(3*sigma),(xBarGlobal-lsl)/(3*sigma));

  document.getElementById('resultadoProfessor').innerHTML=
    `XÃÑ global: ${xBarGlobal.toFixed(3)}<br>RÃÑ global: ${rBarGlobal.toFixed(3)}<br>Cp: ${cp.toFixed(3)}<br>Cpk: ${cpk.toFixed(3)}`;

  window.professorCalculado = {medias, rs, xBarGlobal, rBarGlobal, cp, cpk};
}

// Preencher tabela XÃÑ e R professor
function preencherTabelaProfessor(){
  if(!window.professorCalculado) return;
  for(let i=1;i<=k;i++){
    document.getElementById(`media_${i}`).value = window.professorCalculado.medias[i-1].toFixed(3);
    document.getElementById(`r_${i}`).value = window.professorCalculado.rs[i-1].toFixed(3);
  }
  document.getElementById('feedbackProfessor').innerHTML+="<br>‚úÖ Tabela preenchida automaticamente!";
}

// Gerar relat√≥rio PDF
function gerarPDFAluno(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('studentName').value || "Aluno";

  // Contagem de passos corretos (XÃÑ e R)
  let acertos=0;
  for(let i=1;i<=k;i++){
    let valores=[];
    for(let j=1;j<=n;j++) valores.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
    let mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    let amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
    let mediaAluno=parseFloat(document.getElementById(`media_${i}`).value)||0;
    let rAluno=parseFloat(document.getElementById(`r_${i}`).value)||0;
    if(Math.abs(mediaAluno-mediaCorreta)<=0.001 && Math.abs(rAluno-amplitudeCorreta)<=0.001) acertos++;
  }

  // Verificar Cp e Cpk
  const lsl=parseFloat(document.getElementById('lsl').value)||0;
  const usl=parseFloat(document.getElementById('usl').value)||0;
  const medias=[], rs=[];
  for(let i=1;i<=k;i++){
    medias.push(parseFloat(document.getElementById(`media_${i}`).value)||0);
    rs.push(parseFloat(document.getElementById(`r_${i}`).value)||0);
  }
  const xBarGlobal = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = rs.reduce((a,b)=>a+b,0)/k;
  const sigma = rBarGlobal/d2_table[n];
  const cpCorreto = (usl-lsl)/(6*sigma);
  const cpkCorreto = Math.min((usl-xBarGlobal)/(3*sigma),(xBarGlobal-lsl)/(3*sigma));

  const cpAluno=parseFloat(document.getElementById('cpAluno').value)||0;
  const cpkAluno=parseFloat(document.getElementById('cpkAluno').value)||0;

  let pontosCp = Math.abs(cpAluno-cpCorreto)<=0.01 ? 1 : 0;
  let pontosCpk = Math.abs(cpkAluno-cpkCorreto)<=0.01 ? 1 : 0;

  // Nota 0 a 100
  const nota = ((acertos/k + pontosCp + pontosCpk)/ (1+2) )*100;

  // Montar PDF
  doc.setFontSize(16);
  doc.text(`Relat√≥rio de Desempenho - ${name}`, 10, 20);
  doc.setFontSize(12);
  doc.text(`M√©dias e amplitudes corretas: ${acertos} de ${k}`, 10, 30);
  doc.text(`Cp correto: ${pontosCp ? 'Sim' : 'N√£o'}`, 10, 40);
  doc.text(`Cpk correto: ${pontosCpk ? 'Sim' : 'N√£o'}`, 10, 50);
  doc.text(`Nota: ${nota.toFixed(1)}/100`, 10, 60);
  doc.text(`XÃÑ global: ${xBarGlobal.toFixed(3)}, RÃÑ global: ${rBarGlobal.toFixed(3)}`, 10, 70);
  doc.text(`Cp esperado: ${cpCorreto.toFixed(3)}, Cpk esperado: ${cpkCorreto.toFixed(3)}`, 10, 80);

  doc.save(`${name}_relatorio_capabilidade.pdf`);
}
</script>

</body>
</html>

