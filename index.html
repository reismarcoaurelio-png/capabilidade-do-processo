<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capabilidade do Processo ‚Äì Aluno & Professor</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f6f6f6; }
h1 { text-align: center; }
.step { margin: 15px 0; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
input[type="number"], input[type="text"] { padding: 5px; margin: 5px 0; width: 100px; }
button { padding: 6px 12px; margin: 5px; border: none; border-radius: 6px; background-color: #007bff; color: white; cursor: pointer; }
button:disabled { background-color: #ccc; cursor: not-allowed; }
table { border-collapse: collapse; margin-top: 10px; width: 100%; }
th, td { border: 1px solid #999; padding: 5px; text-align: center; }
</style>
</head>
<body>
<h1>Capabilidade do Processo ‚Äì Entrada de Dados</h1>

<div style="text-align:center; margin-bottom:20px;">
  <label>Nome do estudante: <input type="text" id="studentName" placeholder="Digite seu nome"></label>
</div>

<div>
  <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
  <label>N√∫mero de amostras (k): <input type="number" id="numSamples" min="1"></label>
  <button onclick="gerarTabela()">Gerar Tabela</button>
</div>

<div id="tableContainer" style="display:none;">
  <h3>Preencha as observa√ß√µes</h3>
  <table id="sampleTable"></table>
  <button onclick="verificarMediasER()">Verificar M√©dias e Amplitudes</button>
  <div id="feedback"></div>
</div>

<div class="step">
  <h3>M√≥dulo Professor</h3>
  <label>Senha: <input type="text" id="profPassword"></label>
  <button onclick="ativarProfessor()">Ativar m√≥dulo professor</button>
  <div id="profFeedback"></div>
  <button id="preencherTabelaBtn" onclick="preencherTabelaXR()" disabled>Preencher Tabela com XÃÑ e R</button>
  <div id="profResultados"></div>
</div>

<div class="step">
  <h3>Passo do aluno: Limites e Cp/Cpk</h3>
  <label>Limite inferior (LSL): <input type="number" id="lsl" step="0.001"></label><br>
  <label>Limite superior (USL): <input type="number" id="usl" step="0.001"></label><br>
  <button onclick="calcularCpCpk()">Calcular Cp e Cpk</button>
  <div id="cpkFeedback"></div>
</div>

<div class="step">
  <h3>Resultado Final / Relat√≥rio</h3>
  <button onclick="mostrarNota()">Mostrar Resultado</button>
  <div id="feedbackFinal"></div>
  <button onclick="gerarPDF()">Gerar PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let sampleMedia = [], sampleR = [];
let n=0, k=0;
let XBarGlobal=0, RBarGlobal=0;

function gerarTabela() {
  n = parseInt(document.getElementById('sampleSize').value);
  k = parseInt(document.getElementById('numSamples').value);
  if (isNaN(n) || isNaN(k) || n<2 || n>15 || k<1){ alert("Digite valores v√°lidos!"); return; }

  const table = document.getElementById('sampleTable');
  table.innerHTML = "";
  let thead = "<tr><th>Amostra</th>";
  for(let j=1;j<=n;j++) thead += `<th>X${j}</th>`;
  thead += "<th>M√©dia (XÃÑ)</th><th>R</th></tr>";
  table.innerHTML += thead;

  for(let i=1;i<=k;i++){
    let row = `<tr><td>${i}</td>`;
    for(let j=1;j<=n;j++) row += `<td><input type="number" step="0.001" id="cell_${i}_${j}"></td>`;
    row += `<td><input type="number" step="0.001" id="media_${i}" readonly></td>`;
    row += `<td><input type="number" step="0.001" id="r_${i}" readonly></td></tr>`;
    table.innerHTML += row;
  }
  document.getElementById('tableContainer').style.display = "block";
}

function verificarMediasER() {
  sampleMedia = [];
  sampleR = [];
  let feedback = "";
  let todosCorretos = true;
  for(let i=1;i<=k;i++){
    let valores = [];
    for(let j=1;j<=n;j++){
      valores.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0);
    }
    const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    const amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
    sampleMedia.push(mediaCorreta);
    sampleR.push(amplitudeCorreta);

    const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value) || 0;
    const rAluno = parseFloat(document.getElementById(`r_${i}`).value) || 0;

    if(Math.abs(mediaAluno - mediaCorreta) > 0.001 || Math.abs(rAluno - amplitudeCorreta) > 0.001){
      feedback += `‚ùå Amostra ${i}: M√©dia ou R incorreto(a)<br>`;
      todosCorretos = false;
    } else feedback += `‚úîÔ∏è Amostra ${i}: Correto<br>`;
  }
  if(todosCorretos) feedback = "üéâ Todas as m√©dias e amplitudes est√£o corretas!";
  document.getElementById('feedback').innerHTML = feedback;
}

function ativarProfessor() {
  const senha = document.getElementById('profPassword').value;
  if(senha !== '2806ANdr*'){ alert("Senha incorreta!"); return; }

  sampleMedia = [];
  sampleR = [];
  for(let i=1;i<=k;i++){
    let valores = [];
    for(let j=1;j<=n;j++){
      valores.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0);
    }
    const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    const amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
    sampleMedia.push(mediaCorreta);
    sampleR.push(amplitudeCorreta);
  }
  XBarGlobal = sampleMedia.reduce((a,b)=>a+b,0)/sampleMedia.length;
  RBarGlobal = sampleR.reduce((a,b)=>a+b,0)/sampleR.length;

  document.getElementById('profFeedback').innerHTML = `‚úîÔ∏è M√≥dulo professor ativado.<br>XÃÑ global: ${XBarGlobal.toFixed(3)}, RÃÑ global: ${RBarGlobal.toFixed(3)}`;
  document.getElementById('preencherTabelaBtn').disabled = false;
}

function preencherTabelaXR() {
  for(let i=1;i<=k;i++){
    document.getElementById(`media_${i}`).value = sampleMedia[i-1].toFixed(3);
    document.getElementById(`r_${i}`).value = sampleR[i-1].toFixed(3);
  }
  document.getElementById('profResultados').innerHTML = "‚úîÔ∏è Tabela preenchida com XÃÑ e R.";
}

function calcularCpCpk(){
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(isNaN(lsl) || isNaN(usl) || XBarGlobal==0 || RBarGlobal==0){
    alert("Preencha os limites e ative o m√≥dulo professor primeiro!");
    return;
  }
  const sigma = RBarGlobal/2.0; // simplifica√ß√£o: RÃÑ/d2 aproximado
  const cp = (usl-lsl)/(6*sigma);
  const cpk = Math.min((usl-XBarGlobal)/(3*sigma), (XBarGlobal-lsl)/(3*sigma));
  document.getElementById('cpkFeedback').innerHTML = `Cp: ${cp.toFixed(3)}, Cpk: ${cpk.toFixed(3)}`;
}

function mostrarNota(){
  const name=document.getElementById('studentName').value||'Aluno';
  const passosCorretos = sampleMedia.length>0 && sampleR.length>0 ? 2 : 0;
  const nota=Math.round((passosCorretos/2)*100*100)/100;
  document.getElementById('feedbackFinal').textContent=`${name} ‚Äî Passos corretos: ${passosCorretos}/2. Desempenho: ${nota.toFixed(2)}%`;
}

function gerarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('studentName').value||'Aluno';
  doc.text(`Relat√≥rio do Aluno: ${name}`, 10, 10);
  doc.text(`XÃÑ global: ${XBarGlobal.toFixed(3)}`, 10, 20);
  doc.text(`RÃÑ global: ${RBarGlobal.toFixed(3)}`, 10, 30);
  const lsl = parseFloat(document.getElementById('lsl').value)||0;
  const usl = parseFloat(document.getElementById('usl').value)||0;
  doc.text(`Limites: LSL=${lsl}, USL=${usl}`,10,40);
  const sigma = RBarGlobal/2.0;
  const cp = (usl-lsl)/(6*sigma);
  const cpk = Math.min((usl-XBarGlobal)/(3*sigma), (XBarGlobal-lsl)/(3*sigma));
  doc.text(`Cp: ${cp.toFixed(3)}, Cpk: ${cpk.toFixed(3)}`,10,50);
  doc.save(`${name}_relatorio.pdf`);
}
</script>
</body>
</html>
