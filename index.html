<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avaliação de Capabilidade - Sistema de Ensino</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin: 20px; }
  h1, h2 { text-align: center; }
  .container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table, th, td { border: 1px solid #ccc; text-align: center; }
  th, td { padding: 8px; }
  input[type="number"], input[type="text"], input[type="password"] { width: 90%; padding: 5px; border-radius: 6px; border: 1px solid #ccc; }
  button { margin-top: 10px; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; background-color: #1976d2; color: white; font-weight: bold; }
  button:hover { background-color: #145a96; }
  .professor { background-color: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 15px; }
  #resultado { margin-top: 20px; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<div class="container">
  <h1>Sistema de Avaliação de Capabilidade</h1>

  <h2>Entrada do Aluno</h2>
  <label>Nome do estudante:</label>
  <input type="text" id="nomeAluno" placeholder="Digite seu nome completo"><br><br>

  <label>Tamanho da amostra (n):</label>
  <input type="number" id="n" min="2" value="3"><br><br>

  <label>Número de amostras (k):</label>
  <input type="number" id="k" min="2" value="3"><br><br>

  <button onclick="gerarTabela()">Gerar Tabela</button>

  <div id="tabelaContainer"></div>

  <div id="passosAluno" style="display:none;">
    <h2>Passos de Cálculo do Aluno</h2>
    <p>Após preencher as médias e amplitudes, calcule e insira:</p>
    <label>X̄ Global:</label> <input type="number" id="xBarraGlobalAluno"><br>
    <label>R̄:</label> <input type="number" id="rBarraAluno"><br>
    <label>Sigma (σ = R̄/d₂):</label> <input type="number" id="sigmaAluno"><br><br>

    <button onclick="verificarMedias()">Verificar valores de X̄, R̄ e σ</button>
    
    <div id="limitesEspecificacao" style="display:none;">
      <h3>Limites de Especificação</h3>
      <label>Limite Inferior (LSL):</label> <input type="number" id="lsl"><br>
      <label>Limite Superior (USL):</label> <input type="number" id="usl"><br>
      <label>Cp:</label> <input type="number" id="cpAluno"><br>
      <label>Cpk:</label> <input type="number" id="cpkAluno"><br><br>
      <button onclick="verificarCpCpk()">Verificar Cp e Cpk</button>
    </div>
  </div>

  <div class="professor">
    <h2>Módulo do Professor</h2>
    <label>Senha:</label>
    <input type="password" id="senhaProfessor">
    <button onclick="ativarProfessor()">Entrar</button>
    <div id="areaProfessor" style="display:none;">
      <button onclick="calcularMediasProfessor()">Calcular Médias e Amplitudes</button>
      <button onclick="gerarPDF()">Gerar Relatório PDF</button>
      <p id="calculosProfessor"></p>
    </div>
  </div>

  <p id="resultado"></p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let medias = [];
let amplitudes = [];
let xBarraGlobal = 0, rBarra = 0, sigma = 0;
let nota = 0;

const d2Tabela = {2: 1.128, 3: 1.693, 4: 2.059, 5: 2.326, 6: 2.534, 7: 2.704, 8: 2.847, 9: 2.970, 10: 3.078};

function gerarTabela(){
  const n = parseInt(document.getElementById("n").value);
  const k = parseInt(document.getElementById("k").value);
  let html = "<table><tr><th>Amostra</th>";
  for(let i=1;i<=n;i++){ html += `<th>X${i}</th>`; }
  html += "<th>X̄</th><th>R</th></tr>";
  for(let j=1;j<=k;j++){
    html += `<tr><td>${j}</td>`;
    for(let i=1;i<=n;i++){ html += `<td><input type='number' id='x${j}_${i}'></td>`; }
    html += `<td><input type='number' id='media${j}'></td><td><input type='number' id='amp${j}'></td></tr>`;
  }
  html += "</table>";
  document.getElementById("tabelaContainer").innerHTML = html;
  document.getElementById("passosAluno").style.display = "block";
}

function calcularMediasProfessor(){
  const n = parseInt(document.getElementById("n").value);
  const k = parseInt(document.getElementById("k").value);
  medias = []; amplitudes = [];
  for(let j=1;j<=k;j++){
    let valores = [];
    for(let i=1;i<=n;i++){
      const v = parseFloat(document.getElementById(`x${j}_${i}`).value);
      if(!isNaN(v)) valores.push(v);
    }
    const media = valores.reduce((a,b)=>a+b,0)/valores.length;
    const R = Math.max(...valores)-Math.min(...valores);
    document.getElementById(`media${j}`).value = media.toFixed(2);
    document.getElementById(`amp${j}`).value = R.toFixed(2);
    medias.push(media);
    amplitudes.push(R);
  }
  xBarraGlobal = medias.reduce((a,b)=>a+b,0)/medias.length;
  rBarra = amplitudes.reduce((a,b)=>a+b,0)/amplitudes.length;
  const d2 = d2Tabela[n] || 1.693;
  sigma = rBarra/d2;
  document.getElementById("calculosProfessor").innerText =
    `X̄ Global = ${xBarraGlobal.toFixed(2)}, R̄ = ${rBarra.toFixed(2)}, σ = ${sigma.toFixed(3)}`;
}

function ativarProfessor(){
  const senha = document.getElementById("senhaProfessor").value;
  if(senha === "2806ANdr*"){
    document.getElementById("areaProfessor").style.display = "block";
    alert("Módulo professor ativado.");
  } else {
    alert("Senha incorreta!");
  }
}

function verificarMedias(){
  const xAluno = parseFloat(document.getElementById("xBarraGlobalAluno").value);
  const rAluno = parseFloat(document.getElementById("rBarraAluno").value);
  const sigmaAluno = parseFloat(document.getElementById("sigmaAluno").value);

  const tolerancia = 0.1;
  let acertos = 0;

  if(Math.abs(xAluno - xBarraGlobal) <= tolerancia) acertos++;
  if(Math.abs(rAluno - rBarra) <= tolerancia) acertos++;
  if(Math.abs(sigmaAluno - sigma) <= tolerancia) acertos++;

  nota = (acertos/3)*50; // metade da nota
  document.getElementById("resultado").innerText = `Acertos: ${acertos}/3`;

  if(acertos === 3) document.getElementById("limitesEspecificacao").style.display = "block";
}

function verificarCpCpk(){
  const lsl = parseFloat(document.getElementById("lsl").value);
  const usl = parseFloat(document.getElementById("usl").value);
  const cpAluno = parseFloat(document.getElementById("cpAluno").value);
  const cpkAluno = parseFloat(document.getElementById("cpkAluno").value);

  const cpReal = (usl - lsl)/(6*sigma);
  const cpkReal = Math.min((usl - xBarraGlobal)/(3*sigma), (xBarraGlobal - lsl)/(3*sigma));

  const tolerancia = 0.1;
  let acertos = 0;
  if(Math.abs(cpAluno - cpReal) <= tolerancia) acertos++;
  if(Math.abs(cpkAluno - cpkReal) <= tolerancia) acertos++;

  nota += (acertos/2)*50; // metade restante
  document.getElementById("resultado").innerText =
    `Cp e Cpk: ${acertos}/2 acertos. Nota final: ${nota.toFixed(0)}/100`;
}

function gerarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const nome = document.getElementById("nomeAluno").value;
  doc.text("Relatório de Desempenho do Aluno", 70, 20);
  doc.text(`Aluno: ${nome}`, 20, 40);
  doc.text(`X̄ Global: ${xBarraGlobal.toFixed(2)}`, 20, 60);
  doc.text(`R̄: ${rBarra.toFixed(2)}`, 20, 70);
  doc.text(`σ: ${sigma.toFixed(3)}`, 20, 80);
  doc.text(`Nota Final: ${nota.toFixed(0)} / 100`, 20, 100);
  doc.save(`Relatorio_${nome}.pdf`);
}
</script>
</body>
</html>
