<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Capabilidade do Processo ‚Äî Aluno & Professor (com PPM)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f6f6f6;margin:18px;color:#222}
  h1{text-align:center;margin-bottom:8px}
  .step{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.06);margin:12px 0}
  label{display:inline-block;margin:6px 8px 6px 0}
  input[type="number"],input[type="text"],input[type="password"]{padding:6px;border:1px solid #ccc;border-radius:4px;width:160px}
  input[type="number"].wide{width:260px}
  button{padding:8px 12px;border-radius:6px;border:none;background:#007bff;color:#fff;cursor:pointer;margin-left:6px}
  button.secondary{background:#6c757d}
  button[disabled]{background:#c0c0c0;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:14px}
  th{background:#f2f2f2}
  .feedback{margin-top:8px;font-weight:600;white-space:pre-wrap}
  .small{font-size:13px;color:#555}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .controls{margin-top:8px}
</style>

<!-- jsPDF (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Acrescente isto dentro do <head>, ap√≥s os outros scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
</head>
<body>
<h1>Monitoramento Passo a Passo ‚Äî Capabilidade do Processo</h1>


<!-- üîπ Instru√ß√µes r√°pidas para o aluno -->
<div class="step" style="background:#e8f2ff; border-left:5px solid #007bff; padding:10px; font-size:14px;">
  <strong>Instru√ß√µes r√°pidas:</strong>
  <ul style="margin:5px 0 0 15px; padding:0;">
    <li>1Ô∏è‚É£ Digite seu nome e defina o tamanho (n) e o n√∫mero (k) de amostras.</li>
    <li>2Ô∏è‚É£ Clique em <b>Gerar tabela</b> e preencha os valores medidos.</li>
    <li>3Ô∏è‚É£ Calcule XÃÑ e R de cada amostra e use <b>Verificar M√©dias e R</b>.</li>
    <li>4Ô∏è‚É£ Prossiga passo a passo at√© o final, verificando cada c√°lculo.</li>
    <li>5Ô∏è‚É£ No fim, gere seu <b>relat√≥rio PDF</b> e veja sua nota.</li>
  </ul>
</div>

<!-- Aluno: dados iniciais -->
<div class="step" id="step0">
  <h3>Dados do Estudante (Aluno)</h3>
  <div class="row">
    <label>Nome: <input type="text" id="studentName" placeholder="Seu nome"></label>
    <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
    <label>N√∫mero de amostras (k): <input type="number" id="numSamples" min="1"></label>
    <button onclick="gerarTabela()">Gerar tabela</button>
    <button onclick="preencherExemplo()" class="secondary">Preencher exemplo</button>
  </div>
  <div class="small">Observa√ß√£o: defina n entre 2 e 15. Toler√¢ncia de verifica√ß√£o: ¬±0,1.</div>
</div>

<!-- Tabela entrada (aluno) -->
<div class="step" id="step1" style="display:none">
  <h3>1) Preencha as observa√ß√µes por amostra, XÃÑ (por amostra) e R (por amostra)</h3>
  <div id="tableContainer"><table id="sampleTable"></table></div>
  <div class="controls">
    <button onclick="verificarMediasER()">Verificar M√©dias e R (aluno)</button>
    <button onclick="gerarPDFAluno()" class="secondary">Gerar PDF (aluno)</button>
  </div>
  <div id="feedbackMedias" class="feedback"></div>
</div>

<!-- Aluno: Xbar global, Rbar, sigma via d2 -->
<div class="step" id="step2" style="display:none">
  <h3>2) Calcule XÃÑ global, RÃÑ e œÉ (pelo aluno)</h3>
  <div class="small">Ap√≥s verificar m√©dias por amostra, preencha e solicite verifica√ß√£o.</div>
  <div class="row">
    <label>XÃÑ global: <input type="number" id="xbarGlobalAluno" step="0.001"></label>
    <label>RÃÑ: <input type="number" id="rbarAluno" step="0.001"></label>
    <label>œÉ (via RÃÑ/d‚ÇÇ): <input type="number" id="sigmaAluno" step="0.001"></label>
  </div>
  <div class="controls"><button onclick="verificarGlobalsAluno()">Verificar XÃÑ global, RÃÑ e œÉ</button></div>
  <div id="feedbackGlobals" class="feedback"></div>
</div>

<!-- Aluno: Cp / Cpk -->
<div class="step" id="step3" style="display:none">
  <h3>3) Limites e Cp / Cpk (aluno calcula manualmente)</h3>
  <div class="small">Informe limites e calcule Cp e Cpk manualmente. O sistema apenas verifica.</div>
  <div class="row">
    <label>LIE (Limite Inferior de Especifica√ß√£o): <input type="number" id="lsl" step="0.001"></label>
    <label>LSE (Limite Superior de Especifica√ß√£o): <input type="number" id="usl" step="0.001"></label>
  </div>
  <div class="row" style="margin-top:8px">
    <label>Cp (aluno): <input type="number" id="cpAluno" step="0.001"></label>
    <label>Cpk (aluno): <input type="number" id="cpkAluno" step="0.001"></label>
    <button onclick="verificarCpCpkAluno()">Verificar Cp e Cpk (aluno)</button>
  </div>
  <div id="feedbackCpCpkAluno" class="feedback"></div>
</div>

<!-- Aluno: s (desvio amostral com todas as observa√ß√µes) -->
<div class="step" id="step4" style="display:none">
  <h3>4) Desvio-padr√£o amostral (s) ‚Äî usando todas as observa√ß√µes</h3>
  <div class="small">s = ‚àö(Œ£(x - xÃÑ_global_all)¬≤ / (N - 1)), onde N = n √ó k.</div>
  <div class="row" style="margin-top:8px">
    <label>s (aluno): <input type="number" id="sAluno" step="0.001" class="wide"></label>
    <button onclick="verificarSAluno()">Verificar s</button>
  </div>
  <div id="feedbackS" class="feedback"></div>
</div>

<!-- Aluno: Pp / Ppk -->
<div class="step" id="step5" style="display:none">
  <h3>5) Pp e Ppk (aluno)</h3>
  <div class="small">Com s verificado, calcule Pp e Ppk manualmente e pe√ßa verifica√ß√£o.</div>
  <div class="row" style="margin-top:8px">
    <label>Pp (aluno): <input type="number" id="ppAluno" step="0.001" class="wide"></label>
    <label>Ppk (aluno): <input type="number" id="ppkAluno" step="0.001" class="wide"></label>
    <button onclick="verificarPpPpkAluno()">Verificar Pp e Ppk</button>
  </div>
  <div id="feedbackPpPpk" class="feedback"></div>
</div>

<!-- Aluno: PPM total (passo 6) -->
<div class="step" id="step6" style="display:none">
  <h3>6) Propor√ß√£o fora da especifica√ß√£o (PPM total) ‚Äî aluno</h3>
  <div class="small">Calcule o PPM total (soma das duas caudas) considerando distribui√ß√£o normal com m√©dia = m√©dia real e œÉ = s (desvio amostral global). Resultado em ppm (partes por milh√£o), 1 casa decimal.</div>
  <div class="row" style="margin-top:8px">
    <label>PPM total (aluno): <input type="number" id="ppmAluno" step="0.1" class="wide"></label>
    <button onclick="verificarPpmAluno()">Verificar PPM</button>
  </div>
  <div id="feedbackPPM" class="feedback"></div>
</div>

<!-- M√≥dulo Professor -->
<div class="step" id="stepProfessor">
  <h3>M√≥dulo Professor (protegido)</h3>
  <div class="row">
    <label>Senha: <input type="password" id="profPass" placeholder="senha"></label>
    <button onclick="ativarProfessor()">Ativar Professor</button>
    <button id="showProfValuesBtn" onclick="mostrarValoresProfessor()" style="display:none" class="secondary">Mostrar valores do professor</button>
    <button id="fillByProfBtn" onclick="preencherTabelaProfessor()" style="display:none" class="secondary">Preencher XÃÑ e R (professor)</button>
    <button id="genPdfProfBtn" onclick="gerarPDFProfessor()" style="display:none" class="secondary">Gerar PDF (professor)</button>
  </div>
  <div id="feedbackProfessor" class="feedback"></div>
  <div class="small">Professor: ao ativar, o sistema tenta ler a tabela de observa√ß√µes, calcula valores corretos e permite preencher/gerar relat√≥rio.</div>
</div>

<!-- Resultado / Nota -->
<div class="step" id="stepNota">
  <h3>Resultado / Nota</h3>
  <div class="row">
    <button onclick="mostrarNota()">Calcular & Mostrar Nota</button>
    <button onclick="gerarPDFAluno()" class="secondary">Gerar relat√≥rio do aluno (PDF)</button>
  </div>
  <div id="feedbackFinal" class="feedback"></div>
  <div class="small">Pesos: amostras 30%, XÃÑ/R/œÉ 20%, Cp/Cpk 15%, s 15%, Pp/Ppk 10%, PPM 10% (total 100).</div>
</div>

<script>
/* ---------- Configura√ß√µes e constantes ---------- */
const d2_table = {2:1.128,3:1.693,4:2.059,5:2.326,6:2.534,7:2.704,8:2.847,9:2.97,10:3.078,11:3.173,12:3.258,13:3.336,14:3.407,15:3.472};
const TOL = 0.1; // toler√¢ncia ¬±0,1
const PROFESSOR_PASS = '2806ANdr*';

let n = 0, k = 0;
let XarrAll = []; // matriz [amostra][valor]
let xbars = [];   // valores corretos XÃÑ por amostra (calculados)
let Rs = [];      // valores corretos R por amostra (calculados)
let professorActive = false;
let professorData = null;

/* ---------- Helpers: normal CDF via erf approximation ---------- */
/* Abramowitz & Stegun approximation for erf */
function erf(x){
  // constants
  const a1 =  0.254829592;
  const a2 = -0.284496736;
  const a3 =  1.421413741;
  const a4 = -1.453152027;
  const a5 =  1.061405429;
  const p  =  0.3275911;
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x);
  const t = 1.0/(1.0 + p*x);
  const y = 1.0 - ((((a5*t + a4)*t + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
  return sign*y;
}
function normalCdf(z){
  return 0.5*(1 + erf(z / Math.SQRT2));
}
/* ppm from z: tail probability * 1e6 */
function tailPpmAbove(z){
  // probability above z = 1 - Phi(z)
  const prob = 1 - normalCdf(z);
  return prob * 1e6;
}
function tailPpmBelow(z){
  // probability below z = Phi(z)
  const prob = normalCdf(z);
  return prob * 1e6;
}

/* ---------- Fun√ß√µes: gera√ß√£o/controle da tabela ---------- */
function gerarTabela(){
  const student = document.getElementById('studentName').value.trim();
  n = parseInt(document.getElementById('sampleSize').value);
  k = parseInt(document.getElementById('numSamples').value);
  if(!student){ alert('Digite o nome do estudante.'); return; }
  if(isNaN(n) || n<2 || n>15 || isNaN(k) || k<1){ alert('Informe n (2‚Äì15) e k (>=1).'); return; }

  XarrAll = []; xbars = []; Rs = []; professorData = null; professorActive = false;
  document.getElementById('feedbackProfessor').innerText = '';

  let html = '<tr><th>Amostra</th>';
  for(let j=0;j<n;j++) html += `<th>X${j+1}</th>`;
  html += '<th>XÃÑ (aluno)</th><th>R (aluno)</th></tr>';

  for(let i=0;i<k;i++){
    html += `<tr><td>${i+1}</td>`;
    for(let j=0;j<n;j++){
      html += `<td><input type="number" id="cell_${i}_${j}" step="0.001"></td>`;
    }
    html += `<td><input type="number" id="media_${i}" step="0.001"></td>`;
    html += `<td><input type="number" id="r_${i}" step="0.001"></td></tr>`;
  }
  document.getElementById('sampleTable').innerHTML = html;
  document.getElementById('step1').style.display = 'block';
  // hide later steps until student advances
  document.getElementById('step2').style.display = 'none';
  document.getElementById('step3').style.display = 'none';
  document.getElementById('step4').style.display = 'none';
  document.getElementById('step5').style.display = 'none';
  document.getElementById('step6').style.display = 'none';
  document.getElementById('feedbackMedias').innerText = '';
  document.getElementById('feedbackGlobals').innerText = '';
  document.getElementById('feedbackCpCpkAluno').innerText = '';
  document.getElementById('feedbackS').innerText = '';
  document.getElementById('feedbackPpPpk').innerText = '';
  document.getElementById('feedbackPPM').innerText = '';
}

/* Preencher exemplo r√°pido */
function preencherExemplo(){
  if(!k || !n){ alert('Gere a tabela primeiro.'); return; }
  for(let i=0;i<k;i++){
    for(let j=0;j<n;j++){
      // exemplo: use valores pr√≥ximos de 1000 com varia√ß√£o
      const val = 1000 + (i*0.5) + (j-2)*(0.4);
      document.getElementById(`cell_${i}_${j}`).value = val.toFixed(3);
    }
    document.getElementById(`media_${i}`).value = '';
    document.getElementById(`r_${i}`).value = '';
  }
  alert('Exemplo preenchido. Agora preencha XÃÑ e R (ou ative professor para preencher).');
}

/* ---------- Passo 1: Verificar m√©dias e R (Aluno) ---------- */
function verificarMediasER(){
  if(!k || !n){ alert('Gere a tabela primeiro.'); return; }
  XarrAll = []; xbars = []; Rs = [];

  let feedbackLines = [];
  let allFilled = true;

  for(let i=0;i<k;i++){
    let arr = [];
    let min = Number.POSITIVE_INFINITY, max = Number.NEGATIVE_INFINITY;
    for(let j=0;j<n;j++){
      const raw = document.getElementById(`cell_${i}_${j}`).value;
      const v = parseFloat(raw);
      if(isNaN(v)){ allFilled = false; break; }
      arr.push(v);
      if(v < min) min = v;
      if(v > max) max = v;
    }
    if(!allFilled){ break; }
    XarrAll.push(arr);
    const calcXbar = arr.reduce((a,b)=>a+b,0)/n;
    const calcR = max - min;
    xbars.push(calcXbar);
    Rs.push(calcR);

    const alunoX = parseFloat(document.getElementById(`media_${i}`).value) || NaN;
    const alunoR = parseFloat(document.getElementById(`r_${i}`).value) || NaN;

    const xOk = !isNaN(alunoX) && Math.abs(alunoX - calcXbar) <= TOL;
    const rOk = !isNaN(alunoR) && Math.abs(alunoR - calcR) <= TOL;

    feedbackLines.push(`Amostra ${i+1}: XÃÑ ${xOk ? '‚úîÔ∏è correto' : `‚ùå incorreto`}, R ${rOk ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);
  }

  if(!allFilled){
    document.getElementById('feedbackMedias').innerText = 'Preencha todos os valores das observa√ß√µes antes de verificar.';
    return;
  }

  document.getElementById('feedbackMedias').innerText = feedbackLines.join('\n');

  // desbloqueia pr√≥xima etapa (aluno pode prosseguir mesmo que haja erros)
  document.getElementById('step2').style.display = 'block';
}

/* ---------- Passo 2: Verificar XÃÑ global, RÃÑ e sigma via d2 (Aluno) ---------- */
function verificarGlobalsAluno(){
  if(xbars.length !== k || Rs.length !== k){ alert('Verifique as m√©dias e R por amostra primeiro.'); return; }
  const xbarGlobalAluno = parseFloat(document.getElementById('xbarGlobalAluno').value);
  const rbarAluno = parseFloat(document.getElementById('rbarAluno').value);
  const sigmaAluno = parseFloat(document.getElementById('sigmaAluno').value);

  const xbarGlobalCalc = xbars.reduce((a,b)=>a+b,0)/k;
  const rbarCalc = Rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigmaCalc = rbarCalc / d2;

  let fb = [];
  fb.push(`XÃÑ global: ${(!isNaN(xbarGlobalAluno) && Math.abs(xbarGlobalAluno - xbarGlobalCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);
  fb.push(`RÃÑ: ${(!isNaN(rbarAluno) && Math.abs(rbarAluno - rbarCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);
  fb.push(`œÉ (via RÃÑ/d‚ÇÇ): ${(!isNaN(sigmaAluno) && Math.abs(sigmaAluno - sigmaCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);

  document.getElementById('feedbackGlobals').innerText = fb.join('\n');

  // desbloqueia Cp/Cpk e s
  document.getElementById('step3').style.display = 'block';
  document.getElementById('step4').style.display = 'block';
}

/* ---------- Passo 3: Verificar Cp / Cpk (Aluno) ---------- */
function verificarCpCpkAluno(){
  if(xbars.length !== k || Rs.length !== k){ alert('Verifique as m√©dias por amostra primeiro.'); return; }
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(isNaN(lsl) || isNaN(usl)){ alert('Informe LIE e LSE.'); return; }

  const xbarGlobalCalc = xbars.reduce((a,b)=>a+b,0)/k;
  const rbarCalc = Rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigmaCalc = rbarCalc / d2;

  const cpCalc = (usl - lsl) / (6 * sigmaCalc);
  const cpkCalc = Math.min((usl - xbarGlobalCalc) / (3 * sigmaCalc), (xbarGlobalCalc - lsl) / (3 * sigmaCalc));

  const cpAluno = parseFloat(document.getElementById('cpAluno').value);
  const cpkAluno = parseFloat(document.getElementById('cpkAluno').value);

  let fb = [];
  fb.push(`Cp: ${(!isNaN(cpAluno) && Math.abs(cpAluno - cpCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);
  fb.push(`Cpk: ${(!isNaN(cpkAluno) && Math.abs(cpkAluno - cpkCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);

  document.getElementById('feedbackCpCpkAluno').innerText = fb.join('\n');
}

/* ---------- Passo 4: s (desvio amostral global) ---------- */
function verificarSAluno(){
  if(XarrAll.length !== k || xbars.length !== k){ alert('Verifique as m√©dias por amostra primeiro.'); return; }
  // concatenar todos os valores (somente valores, sem XÃÑ e R)
  const todas = [].concat(...XarrAll);
  if(todas.length < 2){ alert('Dados insuficientes.'); return; }
  const N = todas.length;
  const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
  let soma = 0;
  for(const v of todas) soma += Math.pow(v - mediaGlobal, 2);
  const sCalc = Math.sqrt(soma / (N - 1));

  const sAluno = parseFloat(document.getElementById('sAluno').value);
  const fb = `s: ${(!isNaN(sAluno) && Math.abs(sAluno - sCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`;
  document.getElementById('feedbackS').innerText = fb;

  if(!isNaN(sAluno) && Math.abs(sAluno - sCalc) <= TOL){
    document.getElementById('step5').style.display = 'block';
    document.getElementById('step6').style.display = 'block';
  }
}

/* ---------- Passo 5: Pp / Ppk (Aluno) ---------- */
function verificarPpPpkAluno(){
  if(XarrAll.length !== k){ alert('Verifique as amostras primeiro.'); return; }
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(isNaN(lsl) || isNaN(usl)){ alert('Informe LIE e LSE.'); return; }

  const todas = [].concat(...XarrAll);
  const N = todas.length;
  const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
  let soma = 0;
  for(const v of todas) soma += Math.pow(v - mediaGlobal, 2);
  const sCalc = Math.sqrt(soma / (N - 1));

  const ppCalc = (usl - lsl) / (6 * sCalc);
  const ppkCalc = Math.min((usl - mediaGlobal) / (3 * sCalc), (mediaGlobal - lsl) / (3 * sCalc));

  const ppAluno = parseFloat(document.getElementById('ppAluno').value);
  const ppkAluno = parseFloat(document.getElementById('ppkAluno').value);

  let fb = [];
  fb.push(`Pp: ${(!isNaN(ppAluno) && Math.abs(ppAluno - ppCalc) <= TOL) ? '‚úîÔ∏ècorreto' : `‚ùå incorreto`}`);
  fb.push(`Ppk: ${(!isNaN(ppkAluno) && Math.abs(ppkAluno - ppkCalc) <= TOL) ? '‚úîÔ∏è correto' : `‚ùå incorreto`}`);

  document.getElementById('feedbackPpPpk').innerText = fb.join('\n');
}

/* ---------- Passo 6: PPM total (Aluno) ---------- */
function verificarPpmAluno(){
  if(XarrAll.length !== k){ alert('Verifique as amostras primeiro.'); return; }
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(isNaN(lsl) || isNaN(usl)){ alert('Informe LIE e LSE (passo 3).'); return; }

  const todas = [].concat(...XarrAll);
  const N = todas.length;
  const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
  let soma = 0;
  for(const v of todas) soma += Math.pow(v - mediaGlobal, 2);
  const sCalc = Math.sqrt(soma / (N - 1));

  // z inferior = (LSL - mean) / s; PPM inferior = Phi(z_inf) * 1e6
  const zInf = (lsl - mediaGlobal) / sCalc;
  const zSup = (usl - mediaGlobal) / sCalc;
  const ppmInf = tailPpmBelow(zInf); // parts per million below LSL
  const ppmSup = tailPpmAbove(zSup);  // parts per million above USL
  const ppmTotal = ppmInf + ppmSup;
  const ppmAluno = parseFloat(document.getElementById('ppmAluno').value);

  const ok = !isNaN(ppmAluno) && Math.abs(ppmAluno - ppmTotal)*1e-6 <= TOL;
  document.getElementById('feedbackPPM').innerText = ok ? `‚úîÔ∏è PPM total correto (esperado ${ppmTotal.toFixed(1)} ppm)` : `‚ùå PPM total incorreto (esperado ${ppmTotal.toFixed(1)} ppm)`;
// gera histograma automaticamente
gerarHistograma(mediaGlobal, sCalc, lsl, usl);

}

/* ---------- Histograma autom√°tico no passo final ---------- */
function gerarHistograma(mediaGlobal, sCalc, lsl, usl) {
  // container
  let container = document.getElementById("histContainer");
  if (!container) {
    container = document.createElement("div");
    container.id = "histContainer";
    container.innerHTML = "<h4>Histograma das Observa√ß√µes</h4><canvas id='histCanvas' height='120'></canvas>";
    document.getElementById("step6").appendChild(container);
  }

  const ctx = document.getElementById("histCanvas").getContext("2d");

  // gerar todos os valores
  const todas = [].concat(...XarrAll);
  const minVal = Math.min(...todas);
  const maxVal = Math.max(...todas);
  const bins = 10;
  const binWidth = (maxVal - minVal) / bins;
  const freq = new Array(bins).fill(0);

  // contagem de frequ√™ncia
  todas.forEach(v => {
    let idx = Math.floor((v - minVal) / binWidth);
    if (idx >= bins) idx = bins - 1;
    freq[idx]++;
  });

  const labels = [];
  for (let i = 0; i < bins; i++) {
    const low = minVal + i * binWidth;
    const high = low + binWidth;
    labels.push(low.toFixed(2) + "‚Äì" + high.toFixed(2));
  }

  // remove gr√°fico anterior se existir
  if (window.histChart) window.histChart.destroy();

  // cria novo gr√°fico
  window.histChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Frequ√™ncia",
        data: freq,
        backgroundColor: "rgba(54, 162, 235, 0.5)",
        borderWidth: 1,
        barPercentage: 1.0,   // <-- diferen√ßa 2
        categoryPercentage: 1.0 // <-- diferen√ßa 2
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: "Intervalos de valores" } },
        y: { title: { display: true, text: "Frequ√™ncia" }, beginAtZero: true }
      },
      plugins: {
        annotation: {
          annotations: {
            lsl: {
              type: "line",
              xMin: ((lsl - minVal) / binWidth),
              xMax: ((lsl - minVal) / binWidth),
              borderColor: "red",
              borderWidth: 2,
              label: { content: "LIE", enabled: true, position: "start" }
            },
            linhaMedia: {
  	      type: "line",
              xMin: (mediaGlobal - minVal) / binWidth,
              xMax: (mediaGlobal - minVal) / binWidth,
              borderColor: "green",
              borderWidth: 2,
              label: { content: "M√©dia", enabled: true, position: "top" }
            },
            usl: {
              type: "line",
              xMin: ((usl - minVal) / binWidth),
              xMax: ((usl - minVal) / binWidth),
              borderColor: "red",
              borderWidth: 2,
              label: { content: "LSE", enabled: true, position: "end" }
            }
          }
        }
      }
    }
  });
}


/* ---------- Professor: ativar, calcular e preencher ---------- */
function ativarProfessor(){
  const pass = document.getElementById('profPass').value || '';
  if(pass !== PROFESSOR_PASS){
    document.getElementById('feedbackProfessor').innerText = 'Senha incorreta.';
    professorActive = false;
    return;
  }
  // professor ativado
  professorActive = true;
  // tenta montar XarrAll lendo a tabela (caso aluno n√£o tenha clicado em verificar)
  let ok = true;
  const tmp = [];
  for(let i=0;i<k;i++){
    const arr = [];
    for(let j=0;j<n;j++){
      const raw = document.getElementById(`cell_${i}_${j}`).value;
      const v = parseFloat(raw);
      if(isNaN(v)){ ok = false; break; }
      arr.push(v);
    }
    if(!ok) break;
    tmp.push(arr);
  }
  if(ok){
    XarrAll = tmp;
    // calcula dados e habilita bot√µes
    computeProfessorData();
    document.getElementById('feedbackProfessor').innerText = 'Professor ativado ‚Äî valores calculados.';
    document.getElementById('showProfValuesBtn').style.display = 'inline-block';
    document.getElementById('fillByProfBtn').style.display = 'inline-block';
    document.getElementById('genPdfProfBtn').style.display = 'inline-block';
  } else {
    document.getElementById('feedbackProfessor').innerText = 'Professor ativado ‚Äî tabela incompleta (preencha todas as observa√ß√µes).';
    // permite professor tentar preencher later after student fills
    document.getElementById('showProfValuesBtn').style.display = 'none';
    document.getElementById('fillByProfBtn').style.display = 'none';
    document.getElementById('genPdfProfBtn').style.display = 'none';
  }
}

function computeProfessorData(){
  if(!XarrAll || XarrAll.length !== k) return;
  xbars = []; Rs = [];
  const todas = [];
  for(let i=0;i<k;i++){
    const arr = XarrAll[i];
    const mx = arr.reduce((a,b)=>a+b,0)/n;
    const r = Math.max(...arr) - Math.min(...arr);
    xbars.push(mx);
    Rs.push(r);
    for(const v of arr) todas.push(v);
  }
  const xBarGlobal = xbars.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = Rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigma_viaR = rBarGlobal / d2;

  // s (amostral) com N-1
  const N = todas.length;
  const mediaGlobalTodas = todas.reduce((a,b)=>a+b,0)/N;
  let soma = 0; for(const v of todas) soma += Math.pow(v - mediaGlobalTodas, 2);
  const s = Math.sqrt(soma / (N - 1));

  // Cp/Cpk e Pp/Ppk e PPM se limites informados
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  let cp = null, cpk = null, pp = null, ppk = null, ppmTotal = null;
  if(!isNaN(lsl) && !isNaN(usl)){
    cp = (usl - lsl) / (6 * sigma_viaR);
    cpk = Math.min((usl - xBarGlobal) / (3 * sigma_viaR), (xBarGlobal - lsl) / (3 * sigma_viaR));
    pp = (usl - lsl) / (6 * s);
    ppk = Math.min((usl - mediaGlobalTodas) / (3 * s), (mediaGlobalTodas - lsl) / (3 * s));
    // PPM total (using s and mediaGlobalTodas)
    const zInf = (lsl - mediaGlobalTodas) / s;
    const zSup = (usl - mediaGlobalTodas) / s;
    ppmTotal = tailPpmBelow(zInf) + tailPpmAbove(zSup);
  }

  professorData = {
    medias: xbars.slice(),
    rs: Rs.slice(),
    xBarGlobal, rBarGlobal, sigma_viaR,
    s, cp, cpk, pp, ppk, ppmTotal,
    todas, mediaGlobalTodas
  };
}

/* Mostrar valores calculados pelo professor */
function mostrarValoresProfessor(){
  if(!professorActive || !professorData){ alert('Ative o professor e preencha a tabela com todas as observa√ß√µes antes.'); return; }
  const p = professorData;
  const lines = [];
  for(let i=0;i<k;i++){
    lines.push(`Amostra ${i+1}: XÃÑ(prof)=${p.medias[i].toFixed(4)}, R(prof)=${p.rs[i].toFixed(4)}`);
  }
  lines.push(`XÃÑ global (prof): ${p.xBarGlobal.toFixed(4)}`);
  lines.push(`RÃÑ (prof): ${p.rBarGlobal.toFixed(4)}`);
  lines.push(`œÉ via RÃÑ/d‚ÇÇ (prof): ${p.sigma_viaR.toFixed(4)}`);
  lines.push(`s (desvio amostral, prof): ${p.s.toFixed(4)}`);
  if(p.cp !== null){
    lines.push(`Cp (prof): ${p.cp.toFixed(4)}   Cpk (prof): ${p.cpk.toFixed(4)}`);
    lines.push(`Pp (prof): ${p.pp.toFixed(4)}   Ppk (prof): ${p.ppk.toFixed(4)}`);
    lines.push(`PPM total (prof): ${p.ppmTotal.toFixed(1)} ppm`);
  } else {
    lines.push('Cp/Cpk/Pp/Ppk/PPM: limites (LSL/USL) n√£o informados ‚Äî n√£o calculados');
  }
  document.getElementById('feedbackProfessor').innerText = lines.join('\n');
}

/* Preencher a tabela (professor sobrescreve XÃÑ e R e preenche campos globais) */
function preencherTabelaProfessor(){
  if(!professorActive){ alert('Ative o m√≥dulo professor primeiro.'); return; }
  if(!professorData) computeProfessorData();
  if(!professorData){ alert('Dados insuficientes.'); return; }

  for(let i=0;i<k;i++){
    document.getElementById(`media_${i}`).value = professorData.medias[i].toFixed(3);
    document.getElementById(`r_${i}`).value = professorData.rs[i].toFixed(3);
  }
  // preenche campos globais e sigma via R
  document.getElementById('xbarGlobalAluno').value = professorData.xBarGlobal.toFixed(4);
  document.getElementById('rbarAluno').value = professorData.rBarGlobal.toFixed(4);
  document.getElementById('sigmaAluno').value = professorData.sigma_viaR.toFixed(4);
  // preenche s, Pp/Ppk e Cp/Cpk e PPM se dispon√≠veis
  if(professorData.s !== undefined) document.getElementById('sAluno').value = professorData.s.toFixed(4);
  if(professorData.cp !== null){
    document.getElementById('cpAluno').value = professorData.cp.toFixed(4);
    document.getElementById('cpkAluno').value = professorData.cpk.toFixed(4);
    document.getElementById('ppAluno').value = professorData.pp.toFixed(4);
    document.getElementById('ppkAluno').value = professorData.ppk.toFixed(4);
    document.getElementById('ppmAluno').value = professorData.ppmTotal.toFixed(1);
  }
  alert('Tabela e campos preenchidos com valores do professor.');
}

/* ---------- PDFs: Aluno e Professor ---------- */
function gerarPDFAluno(){
  // monta relat√≥rio simples com as entradas do aluno e feedbacks
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('studentName').value || 'Aluno';
  let y = 12;
  doc.setFontSize(14);
  doc.text(`Relat√≥rio do Aluno ‚Äî ${name}`, 10, y); y += 8;
  doc.setFontSize(11);
  doc.text(`Amostras (n=${n}, k=${k})`, 10, y); y += 8;

  // garantir que XarrAll esteja atualizado (tenta ler a tabela)
  refreshXarrFromTable();

  for(let i=0;i<k;i++){
    const arr = XarrAll[i] || [];
    const alunoX = parseFloat(document.getElementById(`media_${i}`).value);
    const alunoR = parseFloat(document.getElementById(`r_${i}`).value);
    doc.text(`Amostra ${i+1}: [${arr.join(', ')}]`, 10, y); y += 6;
    doc.text(`  XÃÑ (aluno): ${isNaN(alunoX)?'n/d':alunoX.toFixed(4)}   R (aluno): ${isNaN(alunoR)?'n/d':alunoR.toFixed(4)}`, 10, y); y += 8;
    if(y > 265){ doc.addPage(); y = 12; }
  }

  // feedbacks
  doc.text('Feedbacks:', 10, y); y += 6;
  const fb1 = document.getElementById('feedbackMedias').innerText || '';
  const fb2 = document.getElementById('feedbackGlobals').innerText || '';
  const fb3 = document.getElementById('feedbackCpCpkAluno').innerText || '';
  const fb4 = document.getElementById('feedbackS').innerText || '';
  const fb5 = document.getElementById('feedbackPpPpk').innerText || '';
  const fb6 = document.getElementById('feedbackPPM').innerText || '';
  const combined = [fb1, fb2, fb3, fb4, fb5, fb6].filter(s=>s).join('\n\n');
  doc.setFontSize(10);
  doc.text(combined || 'Sem feedbacks ainda.', 10, y);
  y += (combined.split('\n').length + 2) * 5;

  // nota
  mostrarNota(); // atualiza feedbackFinal
  doc.setFontSize(12);
  doc.text(document.getElementById('feedbackFinal').innerText || '', 10, y+6);

  doc.save(`${name}_Relatorio_Aluno.pdf`);
}

function gerarPDFProfessor(){
  if(!professorActive || !professorData){ alert('Ative o professor e calcule os valores antes de gerar PDF.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('studentName').value || 'Aluno';
  let y = 12;
  doc.setFontSize(14);
  doc.text(`Relat√≥rio (Professor) ‚Äî ${name}`, 10, y); y += 8;
  doc.setFontSize(11);
  doc.text(`Amostras (n=${n}, k=${k})`, 10, y); y += 8;

  // lista amostras com compara√ß√£o aluno x professor
  for(let i=0;i<k;i++){
    const arr = XarrAll[i] || [];
    const alunoX = parseFloat(document.getElementById(`media_${i}`).value);
    const alunoR = parseFloat(document.getElementById(`r_${i}`).value);
    const profX = professorData.medias[i];
    const profR = professorData.rs[i];
    doc.text(`Amostra ${i+1}: [${arr.join(', ')}]`, 10, y); y += 6;
    doc.text(`  XÃÑ Aluno: ${isNaN(alunoX)?'n/d':alunoX.toFixed(4)}   XÃÑ Prof: ${profX.toFixed(4)}`, 10, y); y += 6;
    doc.text(`  R Aluno: ${isNaN(alunoR)?'n/d':alunoR.toFixed(4)}     R Prof: ${profR.toFixed(4)}`, 10, y); y += 8;
    if(y > 265){ doc.addPage(); y = 12; }
  }

  doc.text(`XÃÑ global (prof): ${professorData.xBarGlobal.toFixed(4)}`, 10, y); y += 6;
  doc.text(`RÃÑ (prof): ${professorData.rBarGlobal.toFixed(4)}`, 10, y); y += 6;
  doc.text(`œÉ via RÃÑ/d‚ÇÇ (prof): ${professorData.sigma_viaR.toFixed(4)}`, 10, y); y += 6;
  doc.text(`s (desvio amostral, prof): ${professorData.s.toFixed(4)}`, 10, y); y += 6;
  if(professorData.cp !== null){
    doc.text(`Cp (prof): ${professorData.cp.toFixed(4)}   Cpk (prof): ${professorData.cpk.toFixed(4)}`, 10, y); y += 6;
    doc.text(`Pp (prof): ${professorData.pp.toFixed(4)}   Ppk (prof): ${professorData.ppk.toFixed(4)}`, 10, y); y += 6;
    doc.text(`PPM total (prof): ${professorData.ppmTotal.toFixed(1)} ppm`, 10, y); y += 6;
  } else {
    doc.text('Cp/Cpk/Pp/Ppk/PPM: limites (LSL/USL) n√£o informados ‚Äî n√£o calculados', 10, y); y += 6;
  }

  mostrarNota(); // atualiza feedbackFinal
  doc.text(document.getElementById('feedbackFinal').innerText || '', 10, y+6);

  doc.save(`${name}_Relatorio_Professor.pdf`);
}

/* ---------- Nota (0-100) ---------- */
function mostrarNota(){
  // pesos:
  // amostras: 30%
  // XÃÑ/R/œÉ (globais): 20%
  // Cp/Cpk: 15%
  // s (desvio amostral): 15%
  // Pp/Ppk: 10%
  // PPM: 10%
  let nota = 0;

  // A: amostras corretas (por amostra, XÃÑ e R juntos)
  let acertosA = 0;
  for(let i=0;i<k;i++){
    if(!XarrAll[i]) continue;
    const calcX = xbars[i];
    const calcR = Rs[i];
    const alunoX = parseFloat(document.getElementById(`media_${i}`).value);
    const alunoR = parseFloat(document.getElementById(`r_${i}`).value);
    if(!isNaN(alunoX) && !isNaN(alunoR) && Math.abs(alunoX - calcX) <= TOL && Math.abs(alunoR - calcR) <= TOL) acertosA++;
  }
  nota += (acertosA / k) * 30;

  // B: XÃÑ global, RÃÑ, œÉ via RÃÑ/d2
  const xbarGlobalAluno = parseFloat(document.getElementById('xbarGlobalAluno').value);
  const rbarAluno = parseFloat(document.getElementById('rbarAluno').value);
  const sigmaAluno = parseFloat(document.getElementById('sigmaAluno').value);
  const xbarGlobalCalc = xbars.reduce((a,b)=>a+b,0)/k;
  const rbarCalc = Rs.reduce((a,b)=>a+b,0)/k;
  const sigmaCalc = rbarCalc / (d2_table[n] || d2_table[10]);
  if(!isNaN(xbarGlobalAluno) && !isNaN(rbarAluno) && !isNaN(sigmaAluno) &&
     Math.abs(xbarGlobalAluno - xbarGlobalCalc) <= TOL &&
     Math.abs(rbarAluno - rbarCalc) <= TOL &&
     Math.abs(sigmaAluno - sigmaCalc) <= TOL) {
    nota += 20;
  }

  // C: Cp / Cpk (cada um vale metade da parte C)
  let scoreC = 0;
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(!isNaN(lsl) && !isNaN(usl)){
    const cpAluno = parseFloat(document.getElementById('cpAluno').value);
    const cpkAluno = parseFloat(document.getElementById('cpkAluno').value);
    const cpCalc = (usl - lsl) / (6 * sigmaCalc);
    const cpkCalc = Math.min((usl - xbarGlobalCalc) / (3 * sigmaCalc), (xbarGlobalCalc - lsl) / (3 * sigmaCalc));
    if(!isNaN(cpAluno) && Math.abs(cpAluno - cpCalc) <= TOL) scoreC += 7.5;
    if(!isNaN(cpkAluno) && Math.abs(cpkAluno - cpkCalc) <= TOL) scoreC += 7.5;
  }
  nota += scoreC;

  // D: s (desvio amostral com todas as observa√ß√µes) ‚Äî 15 pontos
  let scoreD = 0;
  const sAluno = parseFloat(document.getElementById('sAluno').value);
  const todas = [].concat(...XarrAll);
  if(todas.length === n*k){
    const N = todas.length;
    const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
    let soma = 0; for(const v of todas) soma += Math.pow(v - mediaGlobal, 2);
    const sCalc = Math.sqrt(soma / (N - 1));
    if(!isNaN(sAluno) && Math.abs(sAluno - sCalc) <= TOL) scoreD = 15;
  }
  nota += scoreD;

  // E: Pp / Ppk (cada metade da parte E = 5 + 5 = 10)
  let scoreE = 0;
  const ppAluno = parseFloat(document.getElementById('ppAluno').value);
  const ppkAluno = parseFloat(document.getElementById('ppkAluno').value);
  if(!isNaN(lsl) && !isNaN(usl) && todas.length === n*k){
    const N = todas.length;
    const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
    let soma = 0; for(const v of todas) soma += Math.pow(v - mediaGlobal, 2);
    const sCalc = Math.sqrt(soma / (N - 1));
    const ppCalc = (usl - lsl) / (6 * sCalc);
    const ppkCalc = Math.min((usl - mediaGlobal) / (3 * sCalc), (mediaGlobal - lsl) / (3 * sCalc));
    if(!isNaN(ppAluno) && Math.abs(ppAluno - ppCalc) <= TOL) scoreE += 5;
    if(!isNaN(ppkAluno) && Math.abs(ppkAluno - ppkCalc) <= TOL) scoreE += 5;
  }
  nota += scoreE;

  // F: PPM total (10 pontos)
  let scoreF = 0;
  const ppmAluno = parseFloat(document.getElementById('ppmAluno').value);
  if(!isNaN(lsl) && !isNaN(usl) && todas.length === n*k){
    const N = todas.length;
    const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
    let soma = 0; for(const v of todas) soma += Math.pow(v - mediaGlobal, 2);
    const sCalc = Math.sqrt(soma / (N - 1));
    const zInf = (lsl - mediaGlobal) / sCalc;
    const zSup = (usl - mediaGlobal) / sCalc;
    const ppmCalc = tailPpmBelow(zInf) + tailPpmAbove(zSup);
    if(!isNaN(ppmAluno) && Math.abs(ppmAluno - ppmCalc)*1e-6 <= TOL) scoreF = 10;
  }
  nota += scoreF;

  const notaFinal = Math.round(nota * 10) / 10;
  document.getElementById('feedbackFinal').innerText = `Nota final: ${notaFinal.toFixed(1)} / 100`;
}

/* ---------- Util: ler tabela caso aluno n√£o tenha clicado em verificar ---------- */
function refreshXarrFromTable(){
  if(!k || !n) return;
  const tmp = [];
  for(let i=0;i<k;i++){
    const row = [];
    for(let j=0;j<n;j++){
      const raw = document.getElementById(`cell_${i}_${j}`).value;
      const v = parseFloat(raw);
      if(isNaN(v)) return; // incomplete
      row.push(v);
    }
    tmp.push(row);
  }
  XarrAll = tmp;
  // recompute xbars and Rs local copy
  xbars = []; Rs = [];
  for(let i=0;i<k;i++){
    const arr = XarrAll[i];
    const mx = arr.reduce((a,b)=>a+b,0)/n;
    const r = Math.max(...arr) - Math.min(...arr);
    xbars.push(mx); Rs.push(r);
  }
}

/* periodic refresh to keep XarrAll updated if professor active */
setInterval(()=>{ if(professorActive) refreshXarrFromTable(); }, 1200);

/* ---------- Inicializa√ß√£o segura ---------- */
document.addEventListener('DOMContentLoaded', ()=>{ /* nothing now */ });

</script>
</body>
</html>
