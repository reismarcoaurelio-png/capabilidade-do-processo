<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Capabilidade do Processo - Aluno & Professor</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f6f6f6; color:#222; }
  h1 { text-align:center; margin-bottom:10px; }
  .step { background:#fff; padding:14px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); margin:12px 0; }
  label { display:inline-block; margin:6px 8px 6px 0; }
  input[type="number"], input[type="text"], input[type="password"] { padding:6px; border:1px solid #ccc; border-radius:4px; width:140px; }
  button { padding:8px 12px; border-radius:6px; border:none; background:#007bff; color:white; cursor:pointer; margin-left:6px; }
  button.secondary { background:#6c757d; }
  button[disabled]{ background:#c0c0c0; cursor:not-allowed; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:14px; }
  th { background:#f2f2f2; }
  .feedback { margin-top:8px; font-weight:600; }
  .small { font-size:13px; color:#555; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<h1>Monitoramento Passo a Passo — Capabilidade do Processo</h1>

<!-- Passo 0: Dados do aluno -->
<div class="step" id="step0">
  <h3>Dados do Estudante (Aluno)</h3>
  <label>Nome: <input type="text" id="studentName" placeholder="Seu nome"></label><br>
  <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
  <label>Número de amostras (k): <input type="number" id="numSamples" min="1"></label>
  <button onclick="gerarTabela()">Gerar tabela</button>
  <div class="small">Observação: n entre 2 e 15</div>
</div>

<!-- Passo 1: Preencher amostras -->
<div class="step" id="step1" style="display:none;">
  <h3>1) Preencha os valores de cada amostra, a média (X̄) e a amplitude (R)</h3>
  <div id="tableContainer"><table id="sampleTable"></table></div>
  <button onclick="verificarMediasER()">Verificar médias e R (aluno)</button>
  <div id="feedbackMedias" class="feedback"></div>
</div>

<!-- Passo 2: Calcular X̄ global, R̄ e σ -->
<div class="step" id="step2" style="display:none;">
  <h3>2) Calcule X̄ global, R̄ e σ (pelo aluno)</h3>
  <div class="small">Depois de preencher as médias e R por amostra, calcule:</div>
  <label>X̄ global: <input type="number" id="xbarGlobalAluno" step="0.001"></label><br>
  <label>R̄: <input type="number" id="rbarAluno" step="0.001"></label><br>
  <label>σ estimado: <input type="number" id="sigmaAluno" step="0.001"></label><br>
  <button onclick="verificarGlobalsAluno()">Verificar X̄ global, R̄ e σ</button>
  <div id="feedbackGlobals" class="feedback"></div>
</div>

<!-- Passo 3: Cp e Cpk -->
<div class="step" id="step3" style="display:none;">
  <h3>3) Limites de especificação e Cp / Cpk (aluno calcula)</h3>
  <label>LSL: <input type="number" id="lsl" step="0.001"></label><br>
  <label>USL: <input type="number" id="usl" step="0.001"></label><br>
  <div class="small">Com X̄ global e σ verificados, calcule manualmente:</div>
  <label>Cp: <input type="number" id="cpAluno" step="0.001"></label><br>
  <label>Cpk: <input type="number" id="cpkAluno" step="0.001"></label><br>
  <button onclick="verificarCpCpkAluno()">Verificar Cp e Cpk</button>
  <div id="feedbackCpCpkAluno" class="feedback"></div>
</div>

<!-- Passo 4: Desvio-padrão individual -->
<div class="step" id="step4" style="display:none;">
  <h3>4) Calcule o desvio-padrão individual das observações</h3>
  <div class="small">σ estimado = √(Σ(X - X̄ global)² / (n*k -1))</div>
  <label>σ individual (estimativa): <input type="number" id="sigmaIndividualAluno" step="0.001"></label><br>
  <button onclick="verificarSigmaIndividual()">Verificar σ individual</button>
  <div id="feedbackSigmaIndividual" class="feedback"></div>
</div>

<!-- Passo 5: Pp e Ppk -->
<div class="step" id="step5" style="display:none;">
  <h3>5) Calcule Pp e Ppk (aluno)</h3>
  <label>Pp: <input type="number" id="ppAluno" step="0.001"></label><br>
  <label>Ppk: <input type="number" id="ppkAluno" step="0.001"></label><br>
  <button onclick="verificarPpPpkAluno()">Verificar Pp e Ppk</button>
  <div id="feedbackPpPpkAluno" class="feedback"></div>
</div>

<!-- Passo professor -->
<div class="step" id="stepProfessor">
  <h3>Módulo Professor (protegido)</h3>
  <label>Senha (oculta): <input type="password" id="profPass"></label>
  <button onclick="ativarProfessor()">Ativar Professor</button>
  <div id="feedbackProfessor" class="feedback"></div>
  <div class="small">Quando ativado, o professor pode preencher automaticamente X̄ e R na tabela, calcular X̄ global, R̄, σ, Cp/Cpk, σ individual, Pp/Ppk.</div>
  <div style="margin-top:8px;">
    <button id="fillByProfBtn" onclick="preencherTabelaProfessor()" style="display:none;" class="secondary">Professor: Preencher X̄ e R</button>
    <button id="genPdfBtn" onclick="gerarPDFProfessor()" style="display:none;">Professor: Gerar Relatório PDF</button>
  </div>
</div>

<!-- Passo nota final -->
<div class="step" id="stepNota">
  <h3>Resultado / Nota</h3>
  <button onclick="mostrarNota()">Calcular & Mostrar Nota</button>
  <div id="feedbackFinal" class="feedback"></div>
  <div class="small">Nota ponderada: (amostras)50%, (X̄/R̄/σ)25%, (Cp/Cpk)25% — resultado 0 a 100.</div>
</div>

<script>
// Constantes
const d2_table = {2:1.128,3:1.693,4:2.059,5:2.326,6:2.534,7:2.704,8:2.847,9:2.97,10:3.078,11:3.173,12:3.258,13:3.336,14:3.407,15:3.472};
let n=0, k=0;
let samples = [], xbars = [], Rs=[];

// --- Gerar tabela de amostras ---
function gerarTabela(){
  const name = document.getElementById('studentName').value.trim();
  n = parseInt(document.getElementById('sampleSize').value);
  k = parseInt(document.getElementById('numSamples').value);
  if(!name || n<2 || n>15 || k<1){ alert('Preencha todos os campos corretamente!'); return;}
  samples=[]; xbars=[]; Rs=[];
  let html = '<tr><th>Amostra</th>';
  for(let i=1;i<=n;i++) html += `<th>X${i}</th>`;
  html += '<th>X̄</th><th>R</th></tr>';
  for(let i=0;i<k;i++){
    html += `<tr><td>${i+1}</td>`;
    for(let j=0;j<n;j++){
      html += `<td><input type="number" step="0.001" id="X${i}_${j}"></td>`;
    }
    html += `<td><input type="number" step="0.001" id="Xbar${i}"></td>`;
    html += `<td><input type="number" step="0.001" id="R${i}"></td></tr>`;
  }
  document.getElementById('sampleTable').innerHTML = html;
  document.getElementById('step1').style.display='block';
}

// --- Verificar médias e R ---
function verificarMediasER(){
  let feedback='';
  let ok=true;
  xbars=[]; Rs=[];
  for(let i=0;i<k;i++){
    let Xarr=[]; let min=1e10,max=-1e10;
    for(let j=0;j<n;j++){
      const val = parseFloat(document.getElementById(`X${i}_${j}`).value);
      if(isNaN(val)){ ok=false; feedback='Preencha todos os valores das amostras!'; break;}
      Xarr.push(val);
      if(val<min) min=val;
      if(val>max) max=val;
    }
    if(!ok) break;
    const Xbar = parseFloat(document.getElementById(`Xbar${i}`).value);
    const R = parseFloat(document.getElementById(`R${i}`).value);
    const calcXbar = Xarr.reduce((a,b)=>a+b,0)/n;
    const calcR = max-min;
    xbars.push(calcXbar); Rs.push(calcR);
    if(Math.abs(calcXbar-Xbar)>0.1) feedback+=`Amostra ${i+1}: X̄ incorreto. `; 
    if(Math.abs(calcR-R)>0.1) feedback+=`Amostra ${i+1}: R incorreto. `;
  }
  if(feedback==='') feedback='Médias e amplitudes estão corretas!';
  document.getElementById('feedbackMedias').innerText=feedback;
  if(ok) document.getElementById('step2').style.display='block';
}

// --- Verificar X̄ global, R̄, σ ---
function verificarGlobalsAluno(){
  const XbarGlobal = parseFloat(document.getElementById('xbarGlobalAluno').value);
  const Rbar = parseFloat(document.getElementById('rbarAluno').value);
  const sigma = parseFloat(document.getElementById('sigmaAluno').value);
  const calcXbarGlobal = xbars.reduce((a,b)=>a+b,0)/k;
  const calcRbar = Rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n];
  const calcSigma = calcRbar/d2;
  let feedback='';
  if(Math.abs(XbarGlobal-calcXbarGlobal)>0.1) feedback+='X̄ global incorreto. ';
  if(Math.abs(Rbar-calcRbar)>0.1) feedback+='R̄ incorreto. ';
  if(Math.abs(sigma-calcSigma)>0.1) feedback+='σ incorreto. ';
  if(feedback==='') feedback='X̄ global, R̄ e σ corretos!';
  document.getElementById('feedbackGlobals').innerText=feedback;
  document.getElementById('step3').style.display='block';
}

// --- Verificar Cp e Cpk ---
function verificarCpCpkAluno(){
  const LSL=parseFloat(document.getElementById('lsl').value);
  const USL=parseFloat(document.getElementById('usl').value);
  const XbarGlobal=parseFloat(document.getElementById('xbarGlobalAluno').value);
  const sigma=parseFloat(document.getElementById('sigmaAluno').value);
  const cp=parseFloat(document.getElementById('cpAluno').value);
  const cpk=parseFloat(document.getElementById('cpkAluno').value);
  const calcCp = (USL-LSL)/(6*sigma);
  const calcCpk = Math.min(USL-XbarGlobal, XbarGlobal-LSL)/(3*sigma);
  let feedback='';
  if(Math.abs(cp-calcCp)>0.01) feedback+='Cp incorreto. ';
  if(Math.abs(cpk-calcCpk)>0.01) feedback+='Cpk incorreto. ';
  if(feedback==='') feedback='Cp e Cpk corretos!';
  document.getElementById('feedbackCpCpkAluno').innerText=feedback;
  document.getElementById('step4').style.display='block';
}

// --- Verificar σ individual ---
function verificarSigmaIndividual(){
  const XbarGlobal=parseFloat(document.getElementById('xbarGlobalAluno').value);
  let sum=0, count=0;
  for(let i=0;i<k;i++){
    for(let j=0;j<n;j++){
      const val=parseFloat(document.getElementById(`X${i}_${j}`).value);
      sum += (val-XbarGlobal)**2; count++;
    }
  }
  const calcSigma = Math.sqrt(sum/(n*k-1));
  const sigmaInd = parseFloat(document.getElementById('sigmaIndividualAluno').value);
  let feedback='';
  if(Math.abs(sigmaInd-calcSigma)>0.01) feedback='σ individual incorreto.';
  else feedback='σ individual correto!';
  document.getElementById('feedbackSigmaIndividual').innerText=feedback;
  document.getElementById('step5').style.display='block';
}

// --- Verificar Pp e Ppk ---
function verificarPpPpkAluno(){
  const LSL=parseFloat(document.getElementById('lsl').value);
  const USL=parseFloat(document.getElementById('usl').value);
  const XbarGlobal=parseFloat(document.getElementById('xbarGlobalAluno').value);
  const sigmaInd=parseFloat(document.getElementById('sigmaIndividualAluno').value);
  const pp=parseFloat(document.getElementById('ppAluno').value);
  const ppk=parseFloat(document.getElementById('ppkAluno').value);
  const calcPp = (USL-LSL)/(6*sigmaInd);
  const calcPpk = Math.min(USL-XbarGlobal,XbarGlobal-LSL)/(3*sigmaInd);
  let feedback='';
  if(Math.abs(pp-calcPp)>0.01) feedback+='Pp incorreto. ';
  if(Math.abs(ppk-calcPpk)>0.01) feedback+='Ppk incorreto. ';
  if(feedback==='') feedback='Pp e Ppk corretos!';
  document.getElementById('feedbackPpPpkAluno').innerText=feedback;
}

// --- Professor ---
function ativarProfessor(){
  const pass = document.getElementById('profPass').value;
  if(pass==='2806ANdr*'){
    document.getElementById('fillByProfBtn').style.display='inline';
    document.getElementById('genPdfBtn').style.display='inline';
    document.getElementById('feedbackProfessor').innerText='Professor ativado!';
  } else {
    document.getElementById('feedbackProfessor').innerText='Senha incorreta!';
  }
}
function preencherTabelaProfessor(){
  for(let i=0;i<k;i++){
    let Xarr=[]; let min=1e10,max=-1e10;
    for(let j=0;j<n;j++){
      const val=parseFloat(document.getElementById(`X${i}_${j}`).value);
      Xarr.push(val);
      if(val<min) min=val;
      if(val>max) max=val;
    }
    const Xbar = Xarr.reduce((a,b)=>a+b,0)/n;
    const R = max-min;
    document.getElementById(`Xbar${i}`).value=Xbar.toFixed(3);
    document.getElementById(`R${i}`).value=R.toFixed(3);
  }
  const XbarGlobal = xbars.reduce((a,b)=>a+b,0)/k;
  const Rbar = Rs.reduce((a,b)=>a+b,0)/k;
  const sigma = Rbar/d2_table[n];
  document.getElementById('xbarGlobalAluno').value=XbarGlobal.toFixed(3);
  document.getElementById('rbarAluno').value=Rbar.toFixed(3);
  document.getElementById('sigmaAluno').value=sigma.toFixed(3);
  document.getElementById('step2').style.display='block';
  document.getElementById('step3').style.display='block';
  document.getElementById('step4').style.display='block';
  document.getElementById('step5').style.display='block';
}
function gerarPDFProfessor(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Relatório Capabilidade do Processo",10,10);
  let y=20;
  for(let i=0;i<k;i++){
    doc.text(`Amostra ${i+1}: X̄=${document.getElementById(`Xbar${i}`).value}, R=${document.getElementById(`R${i}`).value}`,10,y); y+=7;
  }
  doc.text(`X̄ global: ${document.getElementById('xbarGlobalAluno').value}`,10,y); y+=7;
  doc.text(`R̄: ${document.getElementById('rbarAluno').value}`,10,y); y+=7;
  doc.text(`σ: ${document.getElementById('sigmaAluno').value}`,10,y); y+=7;
  doc.save("Relatorio_Capabilidade.pdf");
}

// --- Nota ---
function mostrarNota(){
  let nota=0;
  // Passo amostras
  let total=0; let corretas=0;
  for(let i=0;i<k;i++){
    let Xarr=[]; let min=1e10,max=-1e10;
    for(let j=0;j<n;j++){
      const val=parseFloat(document.getElementById(`X${i}_${j}`).value);
      Xarr.push(val);
      if(val<min) min=val;
      if(val>max) max=val;
    }
    const Xbar = parseFloat(document.getElementById(`Xbar${i}`).value);
    const R = parseFloat(document.getElementById(`R${i}`).value);
    const calcXbar = Xarr.reduce((a,b)=>a+b,0)/n;
    const calcR = max-min;
    if(Math.abs(Xbar-calcXbar)<0.1 && Math.abs(R-calcR)<0.1) corretas++;
  }
  nota += 50*(corretas/k);
  // Passo XbarGlobal, Rbar, sigma
  let XbarGlobal=parseFloat(document.getElementById('xbarGlobalAluno').value);
  let Rbar=parseFloat(document.getElementById('rbarAluno').value);
  let sigma=parseFloat(document.getElementById('sigmaAluno').value);
  let calcXbarGlobal = xbars.reduce((a,b)=>a+b,0)/k;
  let calcRbar = Rs.reduce((a,b)=>a+b,0)/k;
  let calcSigma = calcRbar/d2_table[n];
  let acertos=0;
  if(Math.abs(XbarGlobal-calcXbarGlobal)<0.1) acertos++;
  if(Math.abs(Rbar-calcRbar)<0.1) acertos++;
  if(Math.abs(sigma-calcSigma)<0.1) acertos++;
  nota += 25*(acertos/3);
  // Cp e Cpk
  const LSL=parseFloat(document.getElementById('lsl').value);
  const USL=parseFloat(document.getElementById('usl').value);
  const cp=parseFloat(document.getElementById('cpAluno').value);
  const cpk=parseFloat(document.getElementById('cpkAluno').value);
  const calcCp = (USL-LSL)/(6*sigma);
  const calcCpk = Math.min(USL-XbarGlobal, XbarGlobal-LSL)/(3*sigma);
  let acertosCp=0;
  if(Math.abs(cp-calcCp)<0.01) acertosCp++;
  if(Math.abs(cpk-calcCpk)<0.01) acertosCp++;
  nota += 25*(acertosCp/2);
  document.getElementById('feedbackFinal').innerText=`Nota final: ${nota.toFixed(1)}/100`;
}
</script>

</body>
</html>

