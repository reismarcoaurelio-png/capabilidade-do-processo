<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Capabilidade do Processo - Aluno & Professor</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f6f6f6; color:#222; }
  h1 { text-align:center; margin-bottom:10px; }
  .step { background:#fff; padding:14px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); margin:12px 0; }
  label { display:inline-block; margin:6px 8px 6px 0; }
  input[type="number"], input[type="text"], input[type="password"] { padding:6px; border:1px solid #ccc; border-radius:4px; width:140px; }
  button { padding:8px 12px; border-radius:6px; border:none; background:#007bff; color:white; cursor:pointer; margin-left:6px; }
  button.secondary { background:#6c757d; }
  button[disabled]{ background:#c0c0c0; cursor:not-allowed; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:14px; }
  th { background:#f2f2f2; }
  .feedback { margin-top:8px; font-weight:600; }
  .small { font-size:13px; color:#555; }
</style>
<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<h1>Monitoramento Passo a Passo ‚Äî Capabilidade do Processo</h1>

<div class="step">
  <h3>Dados do Estudante (Aluno)</h3>
  <label>Nome: <input type="text" id="studentName" placeholder="Seu nome"></label><br>
  <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
  <label>N√∫mero de amostras (k): <input type="number" id="numSamples" min="1"></label>
  <button onclick="gerarTabela()">Gerar tabela</button>
  <div class="small">Observa√ß√£o: n entre 2 e 15</div>
</div>

<div id="tableBlock" class="step" style="display:none;">
  <h3>1) Preencha os valores de cada amostra, a m√©dia (XÃÑ) e a amplitude (R)</h3>
  <div id="tableContainer"><table id="sampleTable"></table></div>
  <button onclick="verificarMediasER()">Verificar m√©dias e R (aluno)</button>
  <div id="feedbackMedias" class="feedback"></div>
</div>

<div id="globalsBlock" class="step" style="display:none;">
  <h3>2) Calcule XÃÑ global, RÃÑ e œÉ (pelo aluno)</h3>
  <div class="small">Depois de preencher as m√©dias e R por amostra, calcule:</div>
  <label>XÃÑ global (m√©dia das m√©dias): <input type="number" id="xbarGlobalAluno" step="0.001"></label><br>
  <label>RÃÑ (m√©dia das amplitudes): <input type="number" id="rbarAluno" step="0.001"></label><br>
  <label>œÉ estimado (œÉ = RÃÑ / d‚ÇÇ): <input type="number" id="sigmaAluno" step="0.001"></label><br>
  <button onclick="verificarGlobalsAluno()">Verificar XÃÑ global, RÃÑ e œÉ</button>
  <div id="feedbackGlobals" class="feedback"></div>
</div>

<div id="capabilityBlock" class="step" style="display:none;">
  <h3>3) Limites e Cp / Cpk (aluno calcula manualmente)</h3>
  <label>LSL: <input type="number" id="lsl" step="0.001"></label><br>
  <label>USL: <input type="number" id="usl" step="0.001"></label><br>
  <div class="small">Com XÃÑ global e œÉ verificados, calcule manualmente:</div>
  <label>Cp (aluno): <input type="number" id="cpAluno" step="0.001"></label><br>
  <label>Cpk (aluno): <input type="number" id="cpkAluno" step="0.001"></label><br>
  <button onclick="verificarCpCpkAluno()">Verificar Cp e Cpk (aluno)</button>
  <div id="feedbackCpCpkAluno" class="feedback"></div>
</div>

<div class="step">
  <h3>M√≥dulo Professor (protegido)</h3>
  <label>Senha (oculta): <input type="password" id="profPass"></label>
  <button onclick="ativarProfessor()">Ativar Professor</button>
  <div id="feedbackProfessor" class="feedback"></div>
  <div class="small">Quando ativado, o professor pode preencher automaticamente XÃÑ e R na tabela, calcular XÃÑ global, RÃÑ, œÉ e (se LSL/USL informados) Cp/Cpk.</div>
  <div style="margin-top:8px;">
    <button id="fillByProfBtn" onclick="preencherTabelaProfessor()" style="display:none;" class="secondary">Professor: Preencher XÃÑ e R</button>
    <button id="genPdfBtn" onclick="gerarPDFProfessor()" style="display:none;">Professor: Gerar Relat√≥rio PDF</button>
  </div>
</div>

<div class="step">
  <h3>Resultado / Nota</h3>
  <button onclick="mostrarNota()">Calcular & Mostrar Nota</button>
  <div id="feedbackFinal" class="feedback"></div>
  <div class="small">Nota ponderada: (amostras corretas) 50%, (globais XÃÑ/RÃÑ/œÉ) 25%, (Cp/Cpk) 25% ‚Äî resultado 0 a 100.</div>
</div>

<script>
const d2_table = {
  2:1.128,3:1.693,4:2.059,5:2.326,6:2.534,7:2.704,8:2.847,9:2.97,10:3.078,
  11:3.173,12:3.258,13:3.336,14:3.407,15:3.472
};
let n=0, k=0;
let professorAtivado = false;
let professorData = null;
let passosAluno = { samplesCorrectCount: 0, samplesTotal: 0, globalsOk:false, cpOk:false, cpkOk:false };

function gerarTabela(){
  n = parseInt(document.getElementById('sampleSize').value);
  k = parseInt(document.getElementById('numSamples').value);
  if(isNaN(n) || isNaN(k) || n<2 || n>15 || k<1){ alert("Informe n (2‚Äì15) e k (>=1)."); return; }

  const table = document.getElementById('sampleTable');
  table.innerHTML = '';
  let thead = '<tr><th>Amostra</th>';
  for(let j=1;j<=n;j++) thead += `<th>X${j}</th>`;
  thead += '<th>XÃÑ (aluno)</th><th>R (aluno)</th></tr>';
  table.innerHTML = thead;
  for(let i=1;i<=k;i++){
    let row = `<tr><td>${i}</td>`;
    for(let j=1;j<=n;j++) row += `<td><input type="number" step="0.001" id="cell_${i}_${j}"></td>`;
    row += `<td><input type="number" step="0.001" id="media_${i}"></td>`;
    row += `<td><input type="number" step="0.001" id="r_${i}"></td></tr>`;
    table.innerHTML += row;
  }
  document.getElementById('tableBlock').style.display = 'block';
  document.getElementById('globalsBlock').style.display = 'none';
  document.getElementById('capabilityBlock').style.display = 'none';
  document.getElementById('feedbackMedias').innerHTML = '';
  document.getElementById('feedbackGlobals').innerHTML = '';
  document.getElementById('feedbackCpCpkAluno').innerHTML = '';
}

function verificarMediasER(){
  if(!k || !n){ alert("Gere a tabela primeiro."); return; }
  let feedback = '';
  let todasCorretas = true;
  const tol = 0.1; // toler√¢ncia agora ¬±0.1
  for(let i=1;i<=k;i++){
    let valores = [];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value);
      valores.push(isNaN(v)?0:v);
    }
    const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    const amplitudeCorreta = Math.max(...valores) - Math.min(...valores);
    const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value) || 0;
    const rAluno = parseFloat(document.getElementById(`r_${i}`).value) || 0;

    if(Math.abs(mediaAluno - mediaCorreta) > tol || Math.abs(rAluno - amplitudeCorreta) > tol){
      feedback += `‚ùå Amostra ${i}: XÃÑ ou R incorreto(a).<br>`;
      todasCorretas = false;
    } else {
      feedback += `‚úîÔ∏è Amostra ${i}: XÃÑ e R corretos.<br>`;
    }
  }
  if(todasCorretas){
    feedback += 'üéâ Todas as m√©dias e amplitudes est√£o corretas. Agora calcule XÃÑ global, RÃÑ e œÉ (pr√≥ximo passo).';
    document.getElementById('globalsBlock').style.display = 'block';
  }
  document.getElementById('feedbackMedias').innerHTML = feedback;
}

function verificarGlobalsAluno(){
  let tol = 0.1;
  let medias = [], rs = [];
  for(let i=1;i<=k;i++){
    medias.push(parseFloat(document.getElementById(`media_${i}`).value)||0);
    rs.push(parseFloat(document.getElementById(`r_${i}`).value)||0);
  }
  const xbarGlobalCorreta = medias.reduce((a,b)=>a+b,0)/k;
  const rbarCorreta = rs.reduce((a,b)=>a+b,0)/k;
  const sigmaCorreta = rbarCorreta/d2_table[n];

  let xbarAluno = parseFloat(document.getElementById('xbarGlobalAluno').value)||0;
  let rbarAluno = parseFloat(document.getElementById('rbarAluno').value)||0;
  let sigmaAluno = parseFloat(document.getElementById('sigmaAluno').value)||0;

  let feedback = '';
  let ok = true;
  if(Math.abs(xbarAluno - xbarGlobalCorreta)>tol){ feedback+='‚ùå XÃÑ global incorreto.<br>'; ok=false; }
  if(Math.abs(rbarAluno - rbarCorreta)>tol){ feedback+='‚ùå RÃÑ incorreto.<br>'; ok=false; }
  if(Math.abs(sigmaAluno - sigmaCorreta)>tol){ feedback+='‚ùå œÉ incorreto.<br>'; ok=false; }

  if(ok){ feedback = '‚úîÔ∏è XÃÑ global, RÃÑ e œÉ corretos! Pode prosseguir para Cp/Cpk.'; passosAluno.globalsOk = true; }
  else{ passosAluno.globalsOk = false; }
  document.getElementById('feedbackGlobals').innerHTML = feedback;
  document.getElementById('capabilityBlock').style.display = ok ? 'block':'none';
}

function verificarCpCpkAluno(){
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  const sigma = parseFloat(document.getElementById('sigmaAluno').value);
  const xbar = parseFloat(document.getElementById('xbarGlobalAluno').value);
  const tol=0.1;

  if(isNaN(lsl) || isNaN(usl) || isNaN(sigma) || isNaN(xbar)){ alert("Preencha LSL/USL, XÃÑ e œÉ."); return; }

  const cpCorreto = (usl-lsl)/(6*sigma);
  const cpkCorreto = Math.min((usl-xbar)/(3*sigma),(xbar-lsl)/(3*sigma));

  const cpAluno = parseFloat(document.getElementById('cpAluno').value)||0;
  const cpkAluno = parseFloat(document.getElementById('cpkAluno').value)||0;

  let feedback='';
  if(Math.abs(cpAluno-cpCorreto)<=tol){ feedback+='‚úîÔ∏è Cp correto.<br>'; passosAluno.cpOk=true; } else { feedback+='‚ùå Cp incorreto.<br>'; passosAluno.cpOk=false; }
  if(Math.abs(cpkAluno-cpkCorreto)<=tol){ feedback+='‚úîÔ∏è Cpk correto.<br>'; passosAluno.cpkOk=true; } else { feedback+='‚ùå Cpk incorreto.<br>'; passosAluno.cpkOk=false; }

  document.getElementById('feedbackCpCpkAluno').innerHTML = feedback;
}

function ativarProfessor(){
  const pass = document.getElementById('profPass').value;
  if(pass==='prof123'){ 
    professorAtivado=true;
    document.getElementById('feedbackProfessor').innerHTML='‚úîÔ∏è M√≥dulo professor ativado.';
    document.getElementById('fillByProfBtn').style.display='inline-block';
    document.getElementById('genPdfBtn').style.display='inline-block';
  } else { 
    alert("Senha incorreta."); 
  }
}

function preencherTabelaProfessor(){
  if(!professorAtivado){ alert("Ative o m√≥dulo professor."); return; }
  for(let i=1;i<=k;i++){
    let valores=[];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0;
      valores.push(v);
    }
    document.getElementById(`media_${i}`).value = (valores.reduce((a,b)=>a+b,0)/n).toFixed(3);
    document.getElementById(`r_${i}`).value = (Math.max(...valores)-Math.min(...valores)).toFixed(3);
  }
  alert("XÃÑ e R preenchidos automaticamente pelo professor.");
}

function gerarPDFProfessor(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const nome = document.getElementById('studentName').value || 'Aluno';
  doc.text(`Relat√≥rio Capabilidade do Processo ‚Äî ${nome}`,10,10);
  doc.text(`Amostras: ${k}, Tamanho: ${n}`,10,18);
  doc.text("Observa√ß√µes / Feedbacks:",10,26);
  let y=34;
  const fbMed = document.getElementById('feedbackMedias').innerHTML.replace(/<br>/g,'\n').replace(/<[^>]+>/g,'');
  const fbGlob = document.getElementById('feedbackGlobals').innerHTML.replace(/<br>/g,'\n').replace(/<[^>]+>/g,'');
  const fbCp = document.getElementById('feedbackCpCpkAluno').innerHTML.replace(/<br>/g,'\n').replace(/<[^>]+>/g,'');
  doc.text(fbMed,10,y); y+=fbMed.split('\n').length*6;
  doc.text(fbGlob,10,y); y+=fbGlob.split('\n').length*6;
  doc.text(fbCp,10,y);
  doc.save(`${nome}_Relatorio_Capabilidade.pdf`);
}

function mostrarNota(){
  let nota = 0;
  // amostras corretas
  let amostrasCorretas = 0;
  const tol=0.1;
  for(let i=1;i<=k;i++){
    let valores = [];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0;
      valores.push(v);
    }
    const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    const amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
    const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value)||0;
    const rAluno = parseFloat(document.getElementById(`r_${i}`).value)||0;
    if(Math.abs(mediaAluno-mediaCorreta)<=tol && Math.abs(rAluno-amplitudeCorreta)<=tol) amostrasCorretas++;
  }
  nota += (amostrasCorretas/k)*50;
  if(passosAluno.globalsOk) nota+=25;
  if(passosAluno.cpOk && passosAluno.cpkOk) nota+=25;

  document.getElementById('feedbackFinal').innerHTML = `Nota final: ${nota.toFixed(1)} / 100`;
}
</script>
</body>
</html>
