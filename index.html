<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Capabilidade do Processo - Aluno & Professor (Final)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f6f6f6; color:#222; }
  h1 { text-align:center; margin-bottom:10px; }
  .step { background:#fff; padding:14px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); margin:12px 0; }
  label { display:inline-block; margin:6px 8px 6px 0; }
  input[type="number"], input[type="text"], input[type="password"] { padding:6px; border:1px solid #ccc; border-radius:4px; width:140px; }
  input[type="number"].wide { width:220px; }
  button { padding:8px 12px; border-radius:6px; border:none; background:#007bff; color:white; cursor:pointer; margin-left:6px; }
  button.secondary { background:#6c757d; }
  button[disabled]{ background:#c0c0c0; cursor:not-allowed; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:14px; }
  th { background:#f2f2f2; }
  .feedback { margin-top:8px; font-weight:600; }
  .small { font-size:13px; color:#555; }
</style>
<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<h1>Monitoramento Passo a Passo ‚Äî Capabilidade do Processo</h1>

<div class="step">
  <h3>Dados do Estudante (Aluno)</h3>
  <label>Nome: <input type="text" id="studentName" placeholder="Seu nome"></label><br>
  <label>Tamanho da amostra (n): <input type="number" id="sampleSize" min="2" max="15"></label>
  <label>N√∫mero de amostras (k): <input type="number" id="numSamples" min="1"></label>
  <button onclick="gerarTabela()">Gerar tabela</button>
  <div class="small">Observa√ß√£o: n entre 2 e 15</div>
</div>

<div id="tableBlock" class="step" style="display:none;">
  <h3>1) Preencha os valores de cada amostra, a m√©dia (XÃÑ) e a amplitude (R)</h3>
  <div id="tableContainer"><table id="sampleTable"></table></div>
  <button onclick="verificarMediasER()">Verificar m√©dias e R (aluno)</button>
  <div id="feedbackMedias" class="feedback"></div>
</div>

<div id="globalsBlock" class="step" style="display:none;">
  <h3>2) Calcule XÃÑ global, RÃÑ e œÉ (pelo aluno)</h3>
  <div class="small">Depois de preencher as m√©dias e R por amostra, calcule:</div>
  <label>XÃÑ global (m√©dia das m√©dias): <input type="number" id="xbarGlobalAluno" step="0.001"></label><br>
  <label>RÃÑ (m√©dia das amplitudes): <input type="number" id="rbarAluno" step="0.001"></label><br>
  <label>œÉ estimado (œÉ = RÃÑ / d‚ÇÇ): <input type="number" id="sigmaAluno" step="0.001"></label><br>
  <button onclick="verificarGlobalsAluno()">Verificar XÃÑ global, RÃÑ e œÉ</button>
  <div id="feedbackGlobals" class="feedback"></div>
</div>

<div id="capabilityBlock" class="step" style="display:none;">
  <h3>3) Limites e Cp / Cpk (aluno calcula manualmente)</h3>
  <label>LSL: <input type="number" id="lsl" step="0.001"></label><br>
  <label>USL: <input type="number" id="usl" step="0.001"></label><br>
  <div class="small">Com XÃÑ global e œÉ verificados, calcule manualmente:</div>
  <label>Cp (aluno): <input type="number" id="cpAluno" step="0.001"></label><br>
  <label>Cpk (aluno): <input type="number" id="cpkAluno" step="0.001"></label><br>
  <button onclick="verificarCpCpkAluno()">Verificar Cp e Cpk (aluno)</button>
  <div id="feedbackCpCpkAluno" class="feedback"></div>
</div>

<div id="sBlock" class="step" style="display:none;">
  <h3>4) Passo adicional ‚Äî Desvio-padr√£o amostral (s)</h3>
  <div class="small">Calcule o desvio-padr√£o amostral s usando todas as observa√ß√µes (N = n √ó k).</div>
  <label>s (aluno): <input type="number" id="sAluno" step="0.001" class="wide"></label><br>
  <button onclick="verificarSAluno()">Verificar s</button>
  <div id="feedbackS" class="feedback"></div>
</div>

<div id="ppBlock" class="step" style="display:none;">
  <h3>5) Passo adicional ‚Äî Pp e Ppk (baseado em s)</h3>
  <div class="small">Com s correto, calcule manualmente Pp e Ppk:</div>
  <label>Pp (aluno): <input type="number" id="ppAluno" step="0.001" class="wide"></label><br>
  <label>Ppk (aluno): <input type="number" id="ppkAluno" step="0.001" class="wide"></label><br>
  <button onclick="verificarPpPpkAluno()">Verificar Pp e Ppk</button>
  <div id="feedbackPpPpk" class="feedback"></div>
</div>

<div class="step">
  <h3>M√≥dulo Professor (protegido)</h3>
  <label>Senha (oculta): <input type="password" id="profPass"></label>
  <button onclick="ativarProfessor()">Ativar Professor</button>
  <div id="feedbackProfessor" class="feedback"></div>
  <div class="small">Quando ativado, o professor pode preencher automaticamente XÃÑ e R na tabela, calcular XÃÑ global, RÃÑ, œÉ, s, Pp e Ppk (se LSL/USL informados).</div>
  <div style="margin-top:8px;">
    <button id="fillByProfBtn" onclick="preencherTabelaProfessor()" style="display:none;" class="secondary">Professor: Preencher XÃÑ e R</button>
    <button id="genPdfBtn" onclick="gerarPDFProfessor()" style="display:none;">Professor: Gerar Relat√≥rio PDF</button>
  </div>
</div>

<div class="step">
  <h3>Resultado / Nota</h3>
  <button onclick="mostrarNota()">Calcular & Mostrar Nota</button>
  <div id="feedbackFinal" class="feedback"></div>
  <div class="small">Nota ponderada: (amostras corretas) 50%, (globais XÃÑ/RÃÑ/œÉ) 25%, (Cp/Cpk) 12.5%, (Pp/Ppk) 12.5% ‚Äî resultado 0 a 100.</div>
</div>

<script>
/* -------------------------
   Configura√ß√µes e constantes
   ------------------------- */
const d2_table = {
  2:1.128,3:1.693,4:2.059,5:2.326,6:2.534,7:2.704,8:2.847,9:2.97,10:3.078,
  11:3.173,12:3.258,13:3.336,14:3.407,15:3.472
};
let n=0, k=0;
let professorAtivado = false;
let professorData = null;
const TOL = 0.1; // toler√¢ncia global ¬±0.1 (uma casa decimal)

/* ------------------------------------------
   1) Gerar tabela din√¢mica para entrada aluno
   ------------------------------------------ */
function gerarTabela(){
  n = parseInt(document.getElementById('sampleSize').value);
  k = parseInt(document.getElementById('numSamples').value);
  if(isNaN(n) || isNaN(k) || n<2 || n>15 || k<1){
    alert("Informe n (2‚Äì15) e k (>=1).");
    return;
  }

  const table = document.getElementById('sampleTable');
  table.innerHTML = '';
  // cabe√ßalho
  let thead = '<tr><th>Amostra</th>';
  for(let j=1;j<=n;j++) thead += `<th>X${j}</th>`;
  thead += '<th>XÃÑ (aluno)</th><th>R (aluno)</th></tr>';
  table.innerHTML = thead;
  // linhas
  for(let i=1;i<=k;i++){
    let row = `<tr><td>${i}</td>`;
    for(let j=1;j<=n;j++){
      row += `<td><input type="number" step="0.001" id="cell_${i}_${j}"></td>`;
    }
    row += `<td><input type="number" step="0.001" id="media_${i}"></td>`;
    row += `<td><input type="number" step="0.001" id="r_${i}"></td></tr>`;
    table.innerHTML += row;
  }

  // habilita blocos seguintes (o aluno s√≥ prossegue ap√≥s verificar)
  document.getElementById('tableBlock').style.display = 'block';
  document.getElementById('globalsBlock').style.display = 'none';
  document.getElementById('capabilityBlock').style.display = 'none';
  document.getElementById('sBlock').style.display = 'none';
  document.getElementById('ppBlock').style.display = 'none';
  document.getElementById('feedbackMedias').innerHTML = '';
  document.getElementById('feedbackGlobals').innerHTML = '';
  document.getElementById('feedbackCpCpkAluno').innerHTML = '';
  document.getElementById('feedbackS').innerHTML = '';
  document.getElementById('feedbackPpPpk').innerHTML = '';
}

/* -----------------------------------------
   2) Aluno: verificar m√©dias e amplitudes
   ----------------------------------------- */
function verificarMediasER(){
  if(!k || !n){ alert("Gere a tabela primeiro."); return; }
  let feedback = '';
  let todasCorretas = true;
  for(let i=1;i<=k;i++){
    let valores = [];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value);
      valores.push(isNaN(v)?0:v);
    }
    const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    const amplitudeCorreta = Math.max(...valores) - Math.min(...valores);
    const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value) || 0;
    const rAluno = parseFloat(document.getElementById(`r_${i}`).value) || 0;

    if(Math.abs(mediaAluno - mediaCorreta) > TOL || Math.abs(rAluno - amplitudeCorreta) > TOL){
      feedback += `‚ùå Amostra ${i}: XÃÑ ou R incorreto(a).<br>`;
      todasCorretas = false;
    } else {
      feedback += `‚úîÔ∏è Amostra ${i}: XÃÑ e R corretos.<br>`;
    }
  }

  if(todasCorretas){
    feedback += 'üéâ Todas as m√©dias e amplitudes est√£o corretas. Agora calcule XÃÑ global, RÃÑ e œÉ (pr√≥ximo passo).';
    document.getElementById('globalsBlock').style.display = 'block';
  } else {
    feedback += 'Corrija as amostras com erro antes de prosseguir.';
  }
  document.getElementById('feedbackMedias').innerHTML = feedback;
}

/* ---------------------------------------------------
   3) Aluno: calcular XÃÑ global, RÃÑ e œÉ e pedir verifica√ß√£o
   --------------------------------------------------- */
function verificarGlobalsAluno(){
  if(!k || !n){ alert("Gere a tabela primeiro."); return; }
  // calcula valores corretos a partir das observa√ß√µes
  const medias = [], rs = [];
  for(let i=1;i<=k;i++){
    let vals=[];
    for(let j=1;j<=n;j++){
      vals.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0);
    }
    medias.push(vals.reduce((a,b)=>a+b,0)/n);
    rs.push(Math.max(...vals) - Math.min(...vals));
  }
  const xBarGlobalCorreta = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobalCorreta = rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10]; // fallback
  const sigmaCorreto = rBarGlobalCorreta / d2;

  const xbarAluno = parseFloat(document.getElementById('xbarGlobalAluno').value) || 0;
  const rbarAluno = parseFloat(document.getElementById('rbarAluno').value) || 0;
  const sigmaAluno = parseFloat(document.getElementById('sigmaAluno').value) || 0;

  let okX = Math.abs(xbarAluno - xBarGlobalCorreta) <= TOL;
  let okR = Math.abs(rbarAluno - rBarGlobalCorreta) <= TOL;
  let okS = Math.abs(sigmaAluno - sigmaCorreto) <= TOL;

  let feedback = '';
  feedback += okX ? '‚úîÔ∏è XÃÑ global correto.<br>' : `‚ùå XÃÑ global incorreto.<br>`;
  feedback += okR ? '‚úîÔ∏è RÃÑ correto.<br>' : `‚ùå RÃÑ incorreto.<br>`;
  feedback += okS ? '‚úîÔ∏è œÉ correto.<br>' : `‚ùå œÉ incorreto (œÉ esperado ‚âà ${sigmaCorreto.toFixed(3)}).<br>`;

  // desbloqueia passo Cp/Cpk somente se as 3 estiverem corretas
  if(okX && okR && okS){
    document.getElementById('capabilityBlock').style.display = 'block';
    // desbloqueia tamb√©m os passos de s e Pp/Ppk (aluno far√° s, depois Pp/Ppk)
    document.getElementById('sBlock').style.display = 'block';
    feedback += 'OK ‚Äî agora calcule Cp/Cpk, s e depois Pp/Ppk (pr√≥ximos passos).';
    passosAluno.globalsOk = true;
  } else {
    feedback += 'Corrija XÃÑ global, RÃÑ ou œÉ e tente novamente.';
    passosAluno.globalsOk = false;
  }
  document.getElementById('feedbackGlobals').innerHTML = feedback;
}

/* ---------------------------------------------------
   4) Aluno: verifica Cp e Cpk (o aluno inseriu manual)
   --------------------------------------------------- */
function verificarCpCpkAluno(){
  if(!k || !n){ alert("Gere a tabela primeiro."); return; }
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(isNaN(lsl) || isNaN(usl)){ alert("Informe LSL e USL."); return; }

  // calcular xBarGlobal e rBar a partir dos inputs (usamos as observa√ß√µes para obter os corretos)
  const medias = [], rs = [];
  for(let i=1;i<=k;i++){
    let vals=[];
    for(let j=1;j<=n;j++) vals.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
    medias.push(vals.reduce((a,b)=>a+b,0)/n);
    rs.push(Math.max(...vals) - Math.min(...vals));
  }
  const xBarGlobal = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigma = rBarGlobal / d2;

  const cpCorreto = (usl - lsl) / (6 * sigma);
  const cpkCorreto = Math.min((usl - xBarGlobal) / (3 * sigma), (xBarGlobal - lsl) / (3 * sigma));

  const cpAluno = parseFloat(document.getElementById('cpAluno').value) || 0;
  const cpkAluno = parseFloat(document.getElementById('cpkAluno').value) || 0;

  let feedback = '';
  if(Math.abs(cpAluno - cpCorreto) <= TOL){ feedback += `‚úîÔ∏è Cp correto (esperado ‚âà ${cpCorreto.toFixed(3)}).<br>`; passosAluno.cpOk = true; } else { feedback += `‚ùå Cp incorreto (esperado ‚âà ${cpCorreto.toFixed(3)}).<br>`; passosAluno.cpOk = false; }
  if(Math.abs(cpkAluno - cpkCorreto) <= TOL){ feedback += `‚úîÔ∏è Cpk correto (esperado ‚âà ${cpkCorreto.toFixed(3)}).<br>`; passosAluno.cpkOk = true; } else { feedback += `‚ùå Cpk incorreto (esperado ‚âà ${cpkCorreto.toFixed(3)}).<br>`; passosAluno.cpkOk = false; }

  document.getElementById('feedbackCpCpkAluno').innerHTML = feedback;
}

/* ---------------------------------------------------
   5) Aluno: verifica s (desvio amostral) ‚Äî PASSO 6
   --------------------------------------------------- */
function verificarSAluno(){
  if(!k || !n){ alert("Gere a tabela primeiro."); return; }
  // coleta todas as observa√ß√µes
  const valoresTodas = [];
  for(let i=1;i<=k;i++){
    for(let j=1;j<=n;j++){
      valoresTodas.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0);
    }
  }
  const N = valoresTodas.length;
  const mediaGlobal = valoresTodas.reduce((a,b)=>a+b,0)/N;
  // amostral (N-1)
  let somaQuad = 0;
  for(const v of valoresTodas) somaQuad += Math.pow(v - mediaGlobal, 2);
  const sCorreto = Math.sqrt(somaQuad / (N - 1));

  const sAluno = parseFloat(document.getElementById('sAluno').value) || 0;
  let feedback = '';
  if(Math.abs(sAluno - sCorreto) <= TOL){
    feedback = `‚úîÔ∏è s correto (esperado ‚âà ${sCorreto.toFixed(4)}).`;
    // permitir Pp/Ppk
    document.getElementById('ppBlock').style.display = 'block';
    passosAluno.sOk = true;
  } else {
    feedback = `‚ùå s incorreto (esperado ‚âà ${sCorreto.toFixed(4)}). Corrija e tente novamente.`;
    passosAluno.sOk = false;
  }
  // guarda no professorData temporariamente caso professor ativo
  if(professorAtivado){
    if(!professorData) professorData = {};
    professorData.s = sCorreto;
  }
  document.getElementById('feedbackS').innerHTML = feedback;
}

/* ---------------------------------------------------
   6) Aluno: verifica Pp e Ppk (PASSO 7)
   --------------------------------------------------- */
function verificarPpPpkAluno(){
  if(!k || !n){ alert("Gere a tabela primeiro."); return; }
  // precisamos de s (aluno) ou recalcular s correto a partir das observa√ß√µes (usar o correto)
  const valoresTodas = [];
  for(let i=1;i<=k;i++){
    for(let j=1;j<=n;j++){
      valoresTodas.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0);
    }
  }
  const N = valoresTodas.length;
  const mediaGlobal = valoresTodas.reduce((a,b)=>a+b,0)/N;
  let somaQuad = 0;
  for(const v of valoresTodas) somaQuad += Math.pow(v - mediaGlobal, 2);
  const sCorreto = Math.sqrt(somaQuad / (N - 1));

  // LSL/USL necess√°rios
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(isNaN(lsl) || isNaN(usl)){ alert("Informe LSL e USL antes de verificar Pp/Ppk."); return; }

  const ppCorreto = (usl - lsl) / (6 * sCorreto);
  const ppkCorreto = Math.min((usl - mediaGlobal) / (3 * sCorreto), (mediaGlobal - lsl) / (3 * sCorreto));

  const ppAluno = parseFloat(document.getElementById('ppAluno').value) || 0;
  const ppkAluno = parseFloat(document.getElementById('ppkAluno').value) || 0;

  let feedback = '';
  if(Math.abs(ppAluno - ppCorreto) <= TOL){ feedback += `‚úîÔ∏è Pp correto (esperado ‚âà ${ppCorreto.toFixed(3)}).<br>`; passosAluno.ppOk = true; } else { feedback += `‚ùå Pp incorreto (esperado ‚âà ${ppCorreto.toFixed(3)}).<br>`; passosAluno.ppOk = false; }
  if(Math.abs(ppkAluno - ppkCorreto) <= TOL){ feedback += `‚úîÔ∏è Ppk correto (esperado ‚âà ${ppkCorreto.toFixed(3)}).`; passosAluno.ppkOk = true; } else { feedback += `‚ùå Ppk incorreto (esperado ‚âà ${ppkCorreto.toFixed(3)}).`; passosAluno.ppkOk = false; }

  // update professorData if active
  if(professorAtivado){
    if(!professorData) professorData = {};
    professorData.s = sCorreto;
    professorData.pp = ppCorreto;
    professorData.ppk = ppkCorreto;
  }

  document.getElementById('feedbackPpPpk').innerHTML = feedback;
}

/* ---------------------------------------------------
   7) M√≥dulo professor: ativa, calcula e preenche tabela
   --------------------------------------------------- */
function ativarProfessor(){
  const senha = document.getElementById('profPass').value;
  if(senha !== '2806ANdr*'){
    document.getElementById('feedbackProfessor').innerHTML = '‚ùå Senha incorreta.';
    professorAtivado = false;
    return;
  }
  professorAtivado = true;
  if(!k || !n){ document.getElementById('feedbackProfessor').innerHTML = 'Tabela n√£o gerada.'; return; }

  // calcula automaticamente m√©dias e R a partir das observa√ß√µes
  const medias = [], rs = [], todas = [];
  for(let i=1;i<=k;i++){
    let vals=[];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0;
      vals.push(v);
      todas.push(v);
    }
    const media = vals.reduce((a,b)=>a+b,0)/n;
    const r = Math.max(...vals) - Math.min(...vals);
    medias.push(media);
    rs.push(r);
    // preenche na tabela (sobrescreve os campos de aluno)
    document.getElementById(`media_${i}`).value = media.toFixed(3);
    document.getElementById(`r_${i}`).value = r.toFixed(3);
  }

  const xBarGlobal = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigma = rBarGlobal / d2;

  // calcular s (desvio amostral) usando todas as observa√ß√µes (N-1)
  const N = todas.length;
  const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
  let somaQuad = 0;
  for(const v of todas) somaQuad += Math.pow(v - mediaGlobal, 2);
  const s = Math.sqrt(somaQuad / (N - 1));

  // calcula Cp/Cpk apenas se LSL/USL preenchidos
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  let cp = null, cpk = null, pp=null, ppk=null;
  if(!isNaN(lsl) && !isNaN(usl)){
    cp = (usl - lsl) / (6 * sigma);
    cpk = Math.min((usl - xBarGlobal)/(3*sigma), (xBarGlobal - lsl)/(3*sigma));
    // tamb√©m calcula Pp/Ppk com base em s
    pp = (usl - lsl) / (6 * s);
    ppk = Math.min((usl - mediaGlobal)/(3*s), (mediaGlobal - lsl)/(3*s));
    // preenche nos campos (somente para confer√™ncia do professor)
    document.getElementById('cpAluno').value = cp.toFixed(3);
    document.getElementById('cpkAluno').value = cpk.toFixed(3);
    // preenche s e pp/ppk vis√≠veis (n√£o sobreescreve aluno, mas disponibiliza em professorData)
  }

  // guarda tudo em professorData
  professorData = {
    medias, rs, xBarGlobal, rBarGlobal, sigma, s, cp, cpk, pp, ppk
  };

  // feedback e habilitar bot√µes
  let feedback = `‚úîÔ∏è Professor ativado ‚Äî XÃÑ global=${xBarGlobal.toFixed(3)}, RÃÑ=${rBarGlobal.toFixed(3)}, œÉ=${sigma.toFixed(3)}, s=${s.toFixed(4)}`;
  if(cp!==null) feedback += `, Cp=${cp.toFixed(3)}, Cpk=${cpk.toFixed(3)}, Pp=${pp.toFixed(3)}, Ppk=${ppk.toFixed(3)}`;
  document.getElementById('feedbackProfessor').innerHTML = feedback;
  document.getElementById('fillByProfBtn').style.display = 'inline-block';
  document.getElementById('genPdfBtn').style.display = 'inline-block';
}

/* -----------------------------------------
   Preencher tabela com XÃÑ e R (Professor)
   ----------------------------------------- */
function preencherTabelaProfessor(){
  if(!professorAtivado || !professorData){ alert("Ative primeiro o m√≥dulo professor."); return; }
  for(let i=1;i<=k;i++){
    document.getElementById(`media_${i}`).value = professorData.medias[i-1].toFixed(3);
    document.getElementById(`r_${i}`).value = professorData.rs[i-1].toFixed(3);
  }
  // tamb√©m preencher s (apenas para exibi√ß√£o no professor) ‚Äî n√£o sobrescrever o campo do aluno
  document.getElementById('feedbackProfessor').innerHTML += '<br>‚úÖ M√©dias e R preenchidos pelo professor na tabela.';
}

/* -----------------------------------------
   Nota e relat√≥rio PDF (Professor)
   ----------------------------------------- */
function mostrarNota(){
  let nota = 0;
  // A: amostras corretas (peso 50%)
  let amostrasCorretas = 0;
  for(let i=1;i<=k;i++){
    let valores = [];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0;
      valores.push(v);
    }
    const mediaCorreta = valores.reduce((a,b)=>a+b,0)/n;
    const amplitudeCorreta = Math.max(...valores)-Math.min(...valores);
    const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value)||0;
    const rAluno = parseFloat(document.getElementById(`r_${i}`).value)||0;
    if(Math.abs(mediaAluno-mediaCorreta)<=TOL && Math.abs(rAluno-amplitudeCorreta)<=TOL) amostrasCorretas++;
  }
  nota += (amostrasCorretas/k)*50;

  // B: globais (XÃÑ global, RÃÑ, œÉ) peso 25%
  // calcula corretos
  const medias = [], rs = [];
  for(let i=1;i<=k;i++){
    let vals=[];
    for(let j=1;j<=n;j++) vals.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
    medias.push(vals.reduce((a,b)=>a+b,0)/n);
    rs.push(Math.max(...vals)-Math.min(...vals));
  }
  const xBarGlobalCorreta = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobalCorreta = rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigmaCorreto = rBarGlobalCorreta / d2;

  const xbarAluno = parseFloat(document.getElementById('xbarGlobalAluno') ? document.getElementById('xbarGlobalAluno').value : 0) || 0;
  const rbarAluno = parseFloat(document.getElementById('rbarAluno') ? document.getElementById('rbarAluno').value : 0) || 0;
  const sigmaAluno = parseFloat(document.getElementById('sigmaAluno') ? document.getElementById('sigmaAluno').value : 0) || 0;
  const okX = Math.abs(xbarAluno - xBarGlobalCorreta) <= TOL;
  const okR = Math.abs(rbarAluno - rBarGlobalCorreta) <= TOL;
  const okS = Math.abs(sigmaAluno - sigmaCorreto) <= TOL;
  if(okX && okR && okS) nota += 25;

  // C: Cp/Cpk (peso 12.5) e Pp/Ppk (peso 12.5)
  let partC = 0;
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  if(!isNaN(lsl) && !isNaN(usl)){
    // Cp/Cpk corretos (usando sigmaCorreto)
    const cpCorreto = (usl - lsl) / (6 * sigmaCorreto);
    const cpkCorreto = Math.min((usl - xBarGlobalCorreta)/(3*sigmaCorreto), (xBarGlobalCorreta - lsl)/(3*sigmaCorreto));
    const cpAluno = parseFloat(document.getElementById('cpAluno').value) || 0;
    const cpkAluno = parseFloat(document.getElementById('cpkAluno').value) || 0;
    if(Math.abs(cpAluno - cpCorreto) <= TOL) partC += 12.5;
    if(Math.abs(cpkAluno - cpkCorreto) <= TOL) partC += 12.5;

    // Pp/Ppk corretos (usando s amostral)
    // recalcula s
    const todas = [].concat(...(Array.from({length:k}, (_,i)=> {
      return Array.from({length:n}, (_,j)=> parseFloat(document.getElementById(`cell_${i+1}_${j+1}`).value)||0);
    })));
    const N = todas.length;
    const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
    let somaQuad = 0;
    for(const v of todas) somaQuad += Math.pow(v - mediaGlobal, 2);
    const sCorreto = Math.sqrt(somaQuad / (N - 1));
    const ppCorreto = (usl - lsl) / (6 * sCorreto);
    const ppkCorreto = Math.min((usl - mediaGlobal)/(3*sCorreto), (mediaGlobal - lsl)/(3*sCorreto));
    const ppAluno = parseFloat(document.getElementById('ppAluno') ? document.getElementById('ppAluno').value : 0) || 0;
    const ppkAluno = parseFloat(document.getElementById('ppkAluno') ? document.getElementById('ppkAluno').value : 0) || 0;
    if(Math.abs(ppAluno - ppCorreto) <= TOL) partC += 6.25; // note: we split 12.5 entre Pp e Ppk
    if(Math.abs(ppkAluno - ppkCorreto) <= TOL) partC += 6.25;
  }
  nota += partC;

  document.getElementById('feedbackFinal').innerHTML = `Amostras corretas: ${amostrasCorretas}/${k} ‚Äî XÃÑ/R/œÉ corretos: ${okX && okR && okS ? 'Sim' : 'N√£o'} ‚Äî Pontos extras (Cp/Cpk/Pp/Ppk): ${partC.toFixed(2)}<br><strong>Nota: ${nota.toFixed(1)} / 100</strong>`;
}

/* -----------------------------------------
   Gerar PDF do professor (com s, Pp, Ppk)
   ----------------------------------------- */
function gerarPDFProfessor(){
  if(!professorAtivado || !professorData){
    if(!professorAtivado) alert("Ative o m√≥dulo professor antes de gerar PDF.");
    else alert("Professor: dados insuficientes.");
    return;
  }
  // gerar nota para incluir
  mostrarNota();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = (document.getElementById('studentName').value || 'Aluno');
  doc.setFontSize(14);
  doc.text(`Relat√≥rio de Desempenho ‚Äî ${name}`, 10, 14);
  doc.setFontSize(11);

  // incluir resumo da avalia√ß√£o
  const feedback = document.getElementById('feedbackFinal').innerText;
  doc.text(`Resumo: ${feedback}`, 10, 28);

  // incluir valores calculados pelo professor
  const p = professorData;
  let y = 46;
  if(p){
    doc.text(`XÃÑ global (professor): ${p.xBarGlobal.toFixed(4)}`, 10, y); y+=6;
    doc.text(`RÃÑ (professor): ${p.rBarGlobal.toFixed(4)}`, 10, y); y+=6;
    doc.text(`œÉ (via RÃÑ/d2) (professor): ${p.sigma.toFixed(4)}`, 10, y); y+=6;
    doc.text(`s (desvio amostral) (professor): ${p.s.toFixed(4)}`, 10, y); y+=6;
    if(typeof p.cp === 'number' && p.cp!==null){
      doc.text(`Cp (professor): ${p.cp.toFixed(4)}   Cpk (professor): ${p.cpk.toFixed(4)}`, 10, y); y+=6;
      doc.text(`Pp (professor): ${p.pp.toFixed(4)}   Ppk (professor): ${p.ppk.toFixed(4)}`, 10, y); y+=8;
    } else {
      doc.text(`Cp/Cpk/Pp/Ppk: limites (LSL/USL) n√£o informados ‚Äî n√£o calculados`, 10, y); y+=8;
    }
  }

  // incluir linhas das amostras
  doc.text('Amostras (valores, XÃÑ (aluno/prof), R (aluno/prof)):', 10, y); y+=6;
  for(let i=1;i<=k;i++){
    let vals=[];
    for(let j=1;j<=n;j++) vals.push(parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0);
    const mediaAluno = parseFloat(document.getElementById(`media_${i}`).value)||0;
    const rAluno = parseFloat(document.getElementById(`r_${i}`).value)||0;
    const mediaProf = professorData ? professorData.medias[i-1].toFixed(3) : 'n/a';
    const rProf = professorData ? professorData.rs[i-1].toFixed(3) : 'n/a';
    const line = `Amostra ${i}: [${vals.join(', ')}] ‚Äî XÃÑ: ${mediaAluno.toFixed(3)} / ${mediaProf} ‚Äî R: ${rAluno.toFixed(3)} / ${rProf}`;
    if(y > 270){ doc.addPage(); y = 14; }
    doc.text(line, 10, y); y += 6;
  }

  doc.save(`${name}_relatorio_capabilidade.pdf`);
}

/* Utility: manter professorData atual quando ativo (opcional) */
function atualizarProfessorDataIfActive(){
  if(!professorAtivado) return;
  // recalc
  const medias=[], rs=[], todas=[];
  for(let i=1;i<=k;i++){
    let vals=[];
    for(let j=1;j<=n;j++){
      const v = parseFloat(document.getElementById(`cell_${i}_${j}`).value)||0;
      vals.push(v);
      todas.push(v);
    }
    medias.push(vals.reduce((a,b)=>a+b,0)/n);
    rs.push(Math.max(...vals)-Math.min(...vals));
  }
  const xBarGlobal = medias.reduce((a,b)=>a+b,0)/k;
  const rBarGlobal = rs.reduce((a,b)=>a+b,0)/k;
  const d2 = d2_table[n] || d2_table[10];
  const sigma = rBarGlobal/d2;
  // s
  const N = todas.length;
  const mediaGlobal = todas.reduce((a,b)=>a+b,0)/N;
  let somaQuad = 0;
  for(const v of todas) somaQuad += Math.pow(v - mediaGlobal, 2);
  const s = Math.sqrt(somaQuad / (N - 1));
  // Cp/Cpk and Pp/Ppk if limits provided
  const lsl = parseFloat(document.getElementById('lsl').value);
  const usl = parseFloat(document.getElementById('usl').value);
  let cp=null, cpk=null, pp=null, ppk=null;
  if(!isNaN(lsl) && !isNaN(usl)){
    cp = (usl - lsl)/(6*sigma);
    cpk = Math.min((usl - xBarGlobal)/(3*sigma), (xBarGlobal - lsl)/(3*sigma));
    pp = (usl - lsl)/(6*s);
    ppk = Math.min((usl - mediaGlobal)/(3*s), (mediaGlobal - lsl)/(3*s));
  }
  professorData = { medias, rs, xBarGlobal, rBarGlobal, sigma, s, cp, cpk, pp, ppk };
}

// atualizar professorData periodicamente se ativo
setInterval(()=>{ if(professorAtivado) atualizarProfessorDataIfActive(); }, 2000);

</script>
</body>
</html>

